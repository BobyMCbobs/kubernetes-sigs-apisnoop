<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Conformance Testing the Kubernetes API</title>
<meta name="author" content="Stephen Heywood & Caleb Woodbine, ii.nz"/>
<style type="text/css">
.underline { text-decoration: underline; }
</style>
<link rel="stylesheet" href="https://multiplex.kccncna2021.pair.sharing.io/dist/reveal.css"/>

<link rel="stylesheet" href="https://multiplex.kccncna2021.pair.sharing.io/dist/theme/night.css" id="theme"/>

<link rel="stylesheet" href="./ii-style.css"/>
<link rel="stylesheet" href="https://multiplex.kccncna2021.pair.sharing.io/plugin/highlight/zenburn.css"/>
</head>
<body>
<div class="reveal">
<div class="slides">
<section id="sec-title-slide">
<h1>Conformance Testing the Kubernetes API</h1>
<h3>Tooling that Makes the Difference</h3>
<p>Stephen Heywood &amp; Caleb Woodbine, ii.nz</p>
</section>
<aside class="notes">
<p>
Welcome to TITLE
</p>

<p>
Introductions
</p>

</aside>

<section>
<section id="slide-org508212b">
<h2 id="org508212b">About ii</h2>
<aside class="notes">
<p>
STEPHEN
</p>

<ul>
<li>We are with ii, a group in NZ with a focus on cooperative coding.</li>
<li>pairing is sharing for us</li>
<li>you can find us at ii.nz</li>

</ul>

</aside>

<p>
Technical Folks in New Zealand
</p>
<ul>
<li>Focus on Cooperative Coding</li>
<li>Pairing is Sharing</li>
<li><a href="https://ii.nz">ii.nz</a> / <a href="https://ii.coop">ii.coop</a></li>

</ul>

</section>
</section>
<section>
<section id="slide-org860bc35">
<h3 id="org860bc35">People</h3>
<aside class="notes">
<p>
CALEB
</p>

<p>
Who is ii?
</p>
<ul>
<li>Caleb and Stephen, your speakers</li>
<li>Brenda, who makes ii function</li>
<li>Hippie Hacker, founder of ii</li>
<li>Riaan, project manager</li>
<li>Zach, data wizard</li>

</ul>

</aside>

<ul>
<li>Brenda Peel</li>
<li>Caleb Woodbine</li>
<li>Hippie Hacker</li>
<li>Riaan Kleinhans</li>
<li>Stephen Heywood</li>
<li>Zach Mandeville</li>

</ul>

</section>
</section>
<section>
<section id="slide-org3ced444">
<h2 id="org3ced444">Kubernetes Conformance</h2>
<p>
<i>and it&rsquo;s tooling</i>
</p>
</section>
</section>
<section>
<section id="slide-orgdd855da">
<h3 id="orgdd855da">What is Kubernetes Conformance?</h3>
<aside class="notes">
<p>
Stephen: A program by the CNCF to ensure that Kubernetes is the same everywhere
</p>

</aside>

<p>
CNCF Kubernetes Conformance ensures
</p>
<blockquote>
<p>
&#x2026; that every vendor’s version of Kubernetes supports the required APIs, as do open source community versions
</p>
</blockquote>
</section>
</section>
<section>
<section id="slide-orgae33c72">
<h3 id="orgae33c72">Why is Kubernetes Conformance important?</h3>
<ul>
<li>portability of workloads</li>
<li>stable APIs behave the same everywhere</li>
<li>freedom from vendor lock-in</li>
<li>consistency with APIs</li>

</ul>

<aside class="notes">
<p>
Stephen: I expect my workloads to be able run the same anywhere k8s does, regardless of vendor.
</p>

</aside>

</section>
</section>
<section>
<section id="slide-org02cbb9e">
<h3 id="org02cbb9e">Conformance website</h3>
<aside class="notes">
<p>
STEPHEN
</p>

<p>
The web site cncf.io/ck provides a good background and rationale for the Conformance program
</p>

</aside>

<p>
<a href="https://cncf.io/ck">cncf.io/ck</a>
</p>


<div id="org873a0ff" class="figure">
<p><img src="./kubecon-2021-north-america-ck.png" alt="kubecon-2021-north-america-ck.png" />
</p>
</div>
</section>
</section>
<section>
<section id="slide-org553627c">
<h3 id="org553627c">Who can meet your k8spectations?</h3>
<aside class="notes">
<p>
CALEB
</p>

<p>
This list is taken from landscape.cncf.io.
You can have consistent, expected, fully-conformanced behaviour across 67 different vendors.
</p>

</aside>

<p>
Currently, there are <b>67 certified distributions</b>.
</p>

<p>
<a href="https://landscape.cncf.io/category=platform&amp;format=card-mode&amp;grouping=category">landscape.cncf.io</a>
</p>


<div id="org04bd778" class="figure">
<p><img src="./kubecon-2021-north-america-landscape-cncf.png" alt="kubecon-2021-north-america-landscape-cncf.png" />
</p>
</div>

<p>
Click <b>Certified K8s/KCSP/KTP</b> link on the left
</p>

</section>
</section>
<section>
<section id="slide-orga5b5f2a">
<h3 id="orga5b5f2a">k8s-conformance repo</h3>
<aside class="notes">
<p>
CALEB
</p>

<ul>
<li>Vendors are certified, and added to that list, following an open, transparent process on the k8s-conformance repo</li>

</ul>

</aside>

<p>
<a href="https://github.com/cncf/k8s-conformance">https://github.com/cncf/k8s-conformance</a>
</p>


<div id="orgc7e428a" class="figure">
<p><img src="./kubecon-2021-north-america-conformance-repo.png" alt="kubecon-2021-north-america-conformance-repo.png" />
</p>
</div>

</section>
</section>
<section>
<section id="slide-org5a0de47">
<h2 id="org5a0de47">Conformance as Code</h2>
<ul class="fragment roll-in">
<li>defined through the API and a test suite</li>

</ul>
<ul class="fragment roll-in">
<li>allows for tools to be built that fit within k8s workflows</li>

</ul>
<ul class="fragment roll-in">
<li>two examples: Sonobuoy and APISnoop</li>

</ul>

<aside class="notes">
<p>
STEPHEN
</p>

<ul>
<li>defined through the API and a test suite</li>
<li>allows for tools to be built that fit within k8s workflows</li>
<li>two examples: Sonobuoy and APISnoop</li>

</ul>

</aside>

</section>
</section>
<section>
<section id="slide-org386b4e3">
<h2 id="org386b4e3">Tooling that makes the difference</h2>
<div class="outline-text-2" id="text-org386b4e3">
</div>
</section>
</section>
<section>
<section id="slide-org51723d4">
<h3 id="org51723d4">Goals</h3>
<aside class="notes">
<ul>
<li>For the certification to have value, its api must be reliable and consistent.</li>
<li>We can ensure this through conformance tests.</li>
<li>APISnoop is intended to help with all aspects of test coverage.</li>

</ul>

</aside>
<p>
APISnoop is designed to help:
</p>
<ul>
<li><b><b>Identify</b></b> gaps in coverage</li>
<li><b><b>Close</b></b> these gaps with tests</li>
<li><b><b>Prevent</b></b> new gaps from happening</li>

</ul>

</section>
</section>
<section>
<section id="slide-org7763803">
<h2 id="org7763803">Identifying Gaps</h2>
<aside class="notes">
<p>
STEPHEN
</p>

</aside>
</section>
</section>
<section>
<section id="slide-org28ea951">
<h3 id="org28ea951"><a href="https://apisnoop.cncf.io">apisnoop.cncf.io</a></h3>
<aside class="notes">
<ul>
<li>Visualizes test runs as an explorable graph</li>
<li>colour coded for conformance or just tested</li>
<li>sharable links to your concern (eg latest/core/networking)</li>
<li>see conformance progress</li>

</ul>

</aside>
<img src=./kubecon-2021-north-america-sunburst-all-endpoints.png width=1200 />

</section>
</section>
<section>
<section id="slide-org4f162f1">
<h3 id="org4f162f1"><a href="https://apisnoop.cncf.io">apisnoop.cncf.io</a></h3>
<aside class="notes">
<ul>
<li>Visualizes test runs as an explorable graph</li>
<li>colour coded for conformance or just tested</li>
<li>sharable links to your concern (eg latest/core/networking)</li>
<li>see conformance progress</li>

</ul>

</aside>
<img src=./kubecon-2021-north-america-1.23-eligible-endpoints.png width=1200 />

</section>
</section>
<section>
<section id="slide-orge85418a">
<h2 id="orge85418a">Taking Snoop for a test drive in kind</h2>
<aside class="notes">
<p>
Let&rsquo;s demonstrate some tooling by bringing up Snoop in kind
</p>

<ul>
<li>decoupled postgres database</li>
<li>powers each form of APISnoop</li>
<li>populated with:
<ul>
<li>live audit events from cluster</li>
<li>api schema from k/k <a href="https://github.com/kubernetes/kubernetes/tree/master/api/openapi-spec">swagger.json</a></li>
<li>audit events from CI job <a href="https://gcsweb.k8s.io/gcs/kubernetes-jenkins/logs/ci-kubernetes-gce-conformance-latest/1319331777721929728/artifacts/bootstrap-e2e-master/">api-audit.logs</a></li>

</ul></li>

</ul>

<p>
How can I deploy snoopdb in my cluster and ask my own questions about the API shape and usage?
</p>

</aside>

<img src=./apisnoop-logo.png width=400 />
<img src=./kind-logo.png width=400 />

</section>
</section>
<section>
<section id="slide-org3598258">
<h3 id="org3598258">Launching</h3>
<div class="org-src-container">

<pre><code class="shell" >git clone https://github.com/cncf/apisnoop
cd apisnoop/kind
kind create cluster --image kindest/node:v1.22.1 --config kind+apisnoop.yaml
</code></pre>
</div>

<pre class="example" id="orgcf047d0">
Creating cluster "kind" ...
 • Ensuring node image (kindest/node:v1.22.1) 🖼  ...
 ✓ Ensuring node image (kindest/node:v1.22.1) 🖼
 • Preparing nodes 📦 📦   ...
 ✓ Preparing nodes 📦 📦
 • Writing configuration 📜  ...
 ✓ Writing configuration 📜
 • Starting control-plane 🕹️  ...
 ✓ Starting control-plane 🕹️
 • Installing CNI 🔌  ...
 ✓ Installing CNI 🔌
 • Installing StorageClass 💾  ...
 ✓ Installing StorageClass 💾
 • Joining worker nodes 🚜  ...
 ✓ Joining worker nodes 🚜
Set kubectl context to "kind-kind"
You can now use your cluster with:

kubectl cluster-info --context kind-kind

Have a nice day! 👋
</pre>

<aside class="notes">
<p>
Bringing up APISnoop on kind is easy.
</p>

<p>
Clone the APISnoop repo and create a kind cluster with it&rsquo;s configuration.
</p>

</aside>

</section>
</section>
<section>
<section id="slide-org6c98d81">
<h3 id="org6c98d81">Discovering untested endpoints</h3>
<div class="org-src-container">

<pre><code class="shell" >export HOST="${HOST:-localhost}"
psql -U apisnoop -d apisnoop -h $HOST -c "
SELECT
  endpoint,
  kind
FROM testing.untested_stable_endpoint
WHERE
  eligible is true
AND
  category = 'core'
ORDER BY
  kind, endpoint desc
LIMIT 5;"
</code></pre>
</div>

<div class="org-src-container">

<pre><code class="text" >               endpoint               |    kind
--------------------------------------+------------
 createcorev1namespacedpodbinding     | binding
 createcorev1namespacedbinding        | binding
 replacecorev1namespacedevent         | event
 patchcorev1namespacedlimitrange      | limitrange
 listcorev1limitrangeforallnamespaces | limitrange
(5 rows)

</code></pre>
</div>

</section>
</section>
<section>
<section id="slide-orgcc3627f">
<h3 id="orgcc3627f">an example (1/2)</h3>
<aside class="notes">
<p>
with the kind cluster up and apisnoop running on it, we&rsquo;re now able to inspect what&rsquo;s happening.
</p>

</aside>

<p>
create a namespace
</p>
<div class="org-src-container">

<pre><code class="shell" >kubectl create ns kubecon-na-2021
</code></pre>
</div>

<div class="org-src-container">

<pre><code class="text" >namespace/kubecon-na-2021 created
</code></pre>
</div>

</section>
</section>
<section>
<section id="slide-orgbde390b">
<h3 id="orgbde390b">an example (2/2)</h3>
<p>
snooping on your own cluster, with psql!
</p>
<div class="org-src-container">

<pre><code class="shell" >export HOST="${HOST:-localHOST}"
psql -u apisnoop -d apisnoop -h $HOST -c "
select distinct endpoint
from   testing.audit_event
where  endpoint ilike 'space%'
and    useragent like 'kubectl/v1.2%'
order  by endpoint;"
</code></pre>
</div>

<div class="org-src-container">

<pre><code class="text" >          endpoint
-----------------------------
 createcorev1namespace
 listcorev1namespacedservice
(2 rows)

</code></pre>
</div>

</section>
</section>
<section>
<section id="slide-orgbbf2f96">
<h2 id="orgbbf2f96">Why is this important?</h2>
<ul class="fragment roll-in">
<li>find the endpoints that your workloads use</li>

</ul>
<ul class="fragment roll-in">
<li>discover if you are relying on alpha or beta features</li>

</ul>

</section>
</section>
<section>
<section id="slide-org56bc0a4">
<h2 id="org56bc0a4">Closing gaps in Kubernetes Conformance Coverage</h2>
<div class="outline-text-2" id="text-org56bc0a4">
</div>
</section>
</section>
<section>
<section id="slide-org4eb0c96">
<h3 id="org4eb0c96">Demo for an entrypoint of test writing</h3>
<aside class="notes">
<ul>
<li>ii uses pair.sharing.io as our primary tool for projects, it is a shared pairing environment that gives you Kubernetes, a shared terminal, and many more tools.</li>
<li>go to Pair and show process of creating a new instance, mentioning that you will need to be a Kubernetes contributor to use it</li>
<li>go to existing preparared instance (<i>kccncna2021-demo</i>), which has the repos [cncf/apisnoop, apisnoop/ticket-writing] loaded on it and shared with heyste</li>
<li>everyday at ii, we create new instances and work on our projects, then delete the instances at the end of the day</li>
<li>bring up tmate session of instance</li>
<li>show the hostname</li>
<li>list Pods and show that the environment that we&rsquo;re in is in a Pod</li>
<li>describe the core components (Humacs, Ingress, PowerDNS, Cert-Manager, www)</li>
<li>show that Docker is accessible and explain that kind can come up on the side if need be</li>
<li>describe Emacs and org-mode</li>
<li>bring up a empty org-mode buffer and create a src block to describe that we are writing the code and documentation at the same time</li>
<li>navigate to the ticket writing repo in Emacs</li>
<li>copy the <i>mock-template.org</i> file to <i>pod-test.org</i></li>
<li>run through the document and update the test</li>
<li>split the terminal and run the test with <code>watch kubectl get pods -A</code></li>
<li>export the org file of the test to markdown and HTML</li>
<li>copy the HTMl into the <i>~/public<sub>html</sub></i> folder and check it out on the web</li>
<li>commit it to a branch and push</li>
<li>delete the cluster</li>

</ul>

</aside>

</section>
</section>
<section>
<section id="slide-org387eb68">
<h2 id="org387eb68">A special thanks to</h2>
<ul>
<li>any contributors who&rsquo;ve made GA endpoints</li>
<li>all conformance contributors and community members that&rsquo;ve helped get us to ~77% (to date)</li>

</ul>

</section>
</section>
<section>
<section id="slide-org0830224">
<h2 id="org0830224">Thanks to these projects for powering this talk</h2>
<ul>
<li>APISnoop (SnoopDB + Auditlogger)</li>
<li>Cert-Manager</li>
<li>Chromium</li>
<li>External-DNS</li>
<li>Humacs</li>
<li>Kind</li>
<li>Kubernetes</li>
<li>Linux</li>
<li>OBS</li>
<li>Pair</li>
<li>PowerDNS</li>
<li>Reveal.js</li>
<li>Systemd</li>
<li>go-http-server</li>
<li>nginx-ingress</li>
<li>tmate</li>

</ul>

</section>
</section>
<section>
<section id="slide-org9814ef7">
<h2 id="org9814ef7">Get in contact</h2>
<ul>
<li>Slack: #k8s-conformance (Kubernetes Conformance Working Group)</li>
<li>Mailing list: <a href="mailto:kubernetes-sig-architecture@googlegroups.com">kubernetes-sig-architecture@googlegroups.com</a></li>

</ul>

</section>
</section>
<section>
<section id="slide-org3876e32">
<h2 id="org3876e32">Q&amp;A</h2>
</section>
</section>
</div>
</div>
<script src="https://multiplex.kccncna2021.pair.sharing.io/dist/reveal.js"></script>
<script src="https://multiplex.kccncna2021.pair.sharing.io/plugin/markdown/markdown.js"></script>
<script src="https://multiplex.kccncna2021.pair.sharing.io/plugin/notes/notes.js"></script>
<script src="https://multiplex.kccncna2021.pair.sharing.io/plugin/highlight/highlight.js"></script>
<script>
// Full list of configuration options available here:
// https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({

controls: true,
progress: false,
history: false,
center: true,
slideNumber: 'c',
rollingLinks: false,
keyboard: true,
mouseWheel: false,
fragmentInURL: true,
hashOneBasedIndex: false,
pdfSeparateFragments: true,

overview: true,
width: 1200,
height: 800,
margin: 0.00,
minScale: 0.20,
maxScale: 0.90,

transition: 'fade',
transitionSpeed: '1',
multiplex: {
    secret: null, // null if client
    id: '1ea00b34ec29b2a6', // id, obtained from socket.io server
    url: 'https://multiplex.kccncna2021.pair.sharing.io/' // Location of socket.io server
},

// Plugins with reveal.js 4.x
plugins: [ RevealMarkdown, RevealNotes, RevealHighlight,  ],

// Optional libraries used to extend reveal.js
dependencies: [
 { src: 'https://multiplex.kccncna2021.pair.sharing.io/socket.io/socket.io.js', async: true },
 { src: 'https://multiplex.kccncna2021.pair.sharing.io/plugin/multiplex/client.js', async: true }]

});
</script>
</body>
</html>
