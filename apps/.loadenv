

# #+NAME: .loadenv

# If we are on sharing.io, use UID based *_PORTs
if [ $(hostname) = "sharing.io" ]
then
    echo Overwriting .env based on \*-${USER}.sharing.io
(
    # UID based *_PORT used to expose per user postgresql,hasura, and pgadmin ports on same box
    echo HASURA_PORT=$(id -u)0
    echo PGPORT=$(id -u)1
    echo PGADMIN_PORT=$(id -u)2
    echo PGHOST=localhost
    echo PGDATABASE=apisnoop
    echo PGUSER=apisnoop
    echo PGPASS=s3cr3tsauc3
    echo PGPASSFILE=$PWD/pgpass
    echo COMPOSE_PROJECT_NAME=apisnoop_$USER
    # echo $PGHOST:$PGPORT:$PGDATABASE:$PGUSER:$PGPASS > $PWD/pgpass
    echo endpoint: https://$USER-hasura.sharing.io > $PWD/hasura/config.yaml
) > .env
else
   cp .env_sample .env
   cp hasura/config_sample.yaml hasura/config.yaml
fi

export $(grep -v '^#' .env | xargs -d '\n')
PGPASSFILE=$(pwd)/pgpass
echo $PGHOST:$PGPORT:$PGDATABASE:$PGUSER:$PGPASS > $PGPASSFILE
chmod 600 $PGPASSFILE
export CONN="host=127.0.0.1 port=$PGPORT user=$PGUSER dbname=$PGDATABASE password=$PGPASS sslmode=disable client_encoding=UTF8"
