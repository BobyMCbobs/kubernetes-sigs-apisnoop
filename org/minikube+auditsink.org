# -*- ii: apisnoop; -*-
* Minikube

** Prepare
*** Certs
#+begin_src shell
  mkdir -p ~/.minikube/files/etc/ssl/certs
#+end_src

*** Audit-Policy
#+begin_src yaml :tangle ~/.minikube/files/etc/ssl/certs/audit-policy.yaml
  # Log all requests at the Metadata level.
  apiVersion: audit.k8s.io/v1
  kind: Policy
  omitStages:
    - "RequestReceived"
  rules:
  - level: Request
    omitStages:
    - "RequestReceived"
#+end_src

*** audit-sink.yaml
Currently hardcoded. Would be good if we had dynamic.
 #+begin_src yaml :tangle ~/.minikube/files/etc/ssl/certs/audit-sink.yaml
   apiVersion: v1
   kind: Config
   clusters:
   - cluster:
       server: http://10.96.96.96:9900/events
     name: auditsink-cluster
   contexts:
   - context:
       cluster: auditsink-cluster
       user: ""
     name: auditsink-context
   current-context: auditsink-context
   users: []
   preferences: {}
 #+end_src

** Start
#+begin_src shell
  minikube start \
    --insecure-registry "10.0.0.0/24" \
    --addons registry \
    --extra-config=apiserver.audit-policy-file=/etc/ssl/certs/audit-policy.yaml \
    --extra-config=apiserver.audit-log-path=- \
    --extra-config=apiserver.audit-webhook-config-file=/etc/ssl/certs/audit-sink.yaml
#+end_src
