#+TITLE: Ticket 58: Exploring kind_field_path_coverage
#+AUTHOR: Zach Mandeville

* The Ticket
  [[https://gitlab.ii.coop/apisnoop/apisnoop_v3/issues/58][gitlab link]]

  #+BEGIN_QUOTE
Map child fields for every Object/Kind (27k stable required fields total)
  #+END_QUOTE

A rough sketch of what we want:
 - a view that shows kind, field_path, field_kind and audit_id
   A materialized view, built off audit_events, that contained:
 - audit_id, param_schema(body_schema). So we want audit events that have a param_scehma, and their audit_id.
 - 

 given a kind and a field path, grab a list of audit events that have that kind as their param_schema (figure out a better name, let's call it request_kind).  Then, return true or false per audit event, based on whether it's request object contains that field path (eg:
 for field_path ~items.spec.containers~ this request object would return true:
 #+BEGIN_SRC json
 request_object: {
   items: {
     spec: {
      containers: []
     }
   }
 }
 #+END_SRC

 Once we have that process, how do we link to this list for every kind/field_path/field_kind combination. gs
* Process
** Choose a starting kind and field_path to look at
   We'll grab a list of kind, field_path, and field_kinds for podspec field.
#+NAME: Select of pod_spec fields
#+BEGIN_SRC sql-mode
select
distinct kind, field_path, field_kind
from kind_field_path_recursion
where
kind not like '%alpha%'
and kind not like '%beta%'
and field_kind = 'io.k8s.api.core.v1.PodSpec'
and field_path like '%.%'
and field_path not like 'volumes%'
and job = '1178464478988079104'
order by field_path
;
#+END_SRC

#+RESULTS: Select of pod_spec fields
#+begin_src sql-mode
                     kind                     |        field_path        |         field_kind         
----------------------------------------------+--------------------------+----------------------------
 io.k8s.api.core.v1.PodList                   | items.spec               | io.k8s.api.core.v1.PodSpec
 io.k8s.api.apps.v1.DaemonSetList             | items.spec.template.spec | io.k8s.api.core.v1.PodSpec
 io.k8s.api.apps.v1.DeploymentList            | items.spec.template.spec | io.k8s.api.core.v1.PodSpec
 io.k8s.api.apps.v1.ReplicaSetList            | items.spec.template.spec | io.k8s.api.core.v1.PodSpec
 io.k8s.api.apps.v1.StatefulSetList           | items.spec.template.spec | io.k8s.api.core.v1.PodSpec
 io.k8s.api.batch.v1.JobList                  | items.spec.template.spec | io.k8s.api.core.v1.PodSpec
 io.k8s.api.core.v1.ReplicationControllerList | items.spec.template.spec | io.k8s.api.core.v1.PodSpec
 io.k8s.api.core.v1.PodTemplateList           | items.template.spec      | io.k8s.api.core.v1.PodSpec
 io.k8s.api.apps.v1.DaemonSet                 | spec.template.spec       | io.k8s.api.core.v1.PodSpec
 io.k8s.api.apps.v1.Deployment                | spec.template.spec       | io.k8s.api.core.v1.PodSpec
 io.k8s.api.apps.v1.ReplicaSet                | spec.template.spec       | io.k8s.api.core.v1.PodSpec
 io.k8s.api.apps.v1.StatefulSet               | spec.template.spec       | io.k8s.api.core.v1.PodSpec
 io.k8s.api.batch.v1.Job                      | spec.template.spec       | io.k8s.api.core.v1.PodSpec
 io.k8s.api.core.v1.ReplicationController     | spec.template.spec       | io.k8s.api.core.v1.PodSpec
 io.k8s.api.apps.v1.DaemonSetSpec             | template.spec            | io.k8s.api.core.v1.PodSpec
 io.k8s.api.apps.v1.DeploymentSpec            | template.spec            | io.k8s.api.core.v1.PodSpec
 io.k8s.api.apps.v1.ReplicaSetSpec            | template.spec            | io.k8s.api.core.v1.PodSpec
 io.k8s.api.apps.v1.StatefulSetSpec           | template.spec            | io.k8s.api.core.v1.PodSpec
 io.k8s.api.batch.v1.JobSpec                  | template.spec            | io.k8s.api.core.v1.PodSpec
 io.k8s.api.core.v1.PodTemplate               | template.spec            | io.k8s.api.core.v1.PodSpec
 io.k8s.api.core.v1.ReplicationControllerSpec | template.spec            | io.k8s.api.core.v1.PodSpec
(21 rows)

#+end_src

We can move from a small path to a larger one.  I'll start from the bottom, so the kind will be  ~io.k8s.api.core.v1.PodTemplate~, and the field_path will be   ~template.spec~

** First Pass: kind is Podlist, field path items.spec
   
   So my initial quest is to see if we can insert our podspec_field as a variable to to check whether that path exists in a request object. 
   It looks like we can, through a _slight_ hack of constructing a string using that var and then casting it to a jsonpath.  this lets us perform the ~json_path_exists~ function.
   #+BEGIN_SRC sql-mode
     WITH pathvar(var, badvar) as (values ('template.spec', 'zach.is.cool'))
     select 
       jsonb_path_exists(request_object, ('$.'||pathvar.var)::jsonpath) as should_be_t,
       jsonb_path_exists(request_object, ('$.'||pathvar.badvar)::jsonpath) as should_be_f
     from
     (select request_object from audit_event where param_schema ilike '%io.k8s.api.core.v1.PodTemplate%' limit 5) as ro, pathvar;
   #+END_SRC

   #+RESULTS:
   #+begin_src sql-mode
    should_be_t | should_be_f 
   -------------+-------------
    t           | f
    t           | f
    t           | f
    t           | f
    t           | f
   (5 rows)

   #+end_src

   So now, how would we construct this as a dynamic variable?  this will let us star tto construct a view that gives us a count of how many audit id's match.
** Basic Query using json_path_exists
 
  I want to be able to return to this query easily, so i'll save it as a view.  This'll need to change of course. 
   #+NAME: basic query for json_path_exists
   #+BEGIN_SRC sql-mode
   CREATE OR REPLACE VIEW "public"."fieldwork" AS
     select
       distinct kind, field_path, field_kind
       from kind_field_path_recursion
      where
     kind not like '%alpha%'
     and kind not like '%beta%'
     and field_kind = 'io.k8s.api.core.v1.PodSpec'
     and field_path like '%.%'
     and field_path not like 'volumes%'
     and job = '1178464478988079104';
   #+END_SRC

   #+RESULTS: basic query for json_path_exists
   #+begin_src sql-mode
   CREATE VIEW
   #+end_src

   So we can now refer to these 21 values easily.
   
   #+BEGIN_SRC sql-mode
select * from fieldwork;
   #+END_SRC

   #+RESULTS:
   #+begin_src sql-mode
                        kind                     |        field_path        |         field_kind         
   ----------------------------------------------+--------------------------+----------------------------
    io.k8s.api.apps.v1.DaemonSet                 | spec.template.spec       | io.k8s.api.core.v1.PodSpec
    io.k8s.api.apps.v1.DaemonSetList             | items.spec.template.spec | io.k8s.api.core.v1.PodSpec
    io.k8s.api.apps.v1.DaemonSetSpec             | template.spec            | io.k8s.api.core.v1.PodSpec
    io.k8s.api.apps.v1.Deployment                | spec.template.spec       | io.k8s.api.core.v1.PodSpec
    io.k8s.api.apps.v1.DeploymentList            | items.spec.template.spec | io.k8s.api.core.v1.PodSpec
    io.k8s.api.apps.v1.DeploymentSpec            | template.spec            | io.k8s.api.core.v1.PodSpec
    io.k8s.api.apps.v1.ReplicaSet                | spec.template.spec       | io.k8s.api.core.v1.PodSpec
    io.k8s.api.apps.v1.ReplicaSetList            | items.spec.template.spec | io.k8s.api.core.v1.PodSpec
    io.k8s.api.apps.v1.ReplicaSetSpec            | template.spec            | io.k8s.api.core.v1.PodSpec
    io.k8s.api.apps.v1.StatefulSet               | spec.template.spec       | io.k8s.api.core.v1.PodSpec
    io.k8s.api.apps.v1.StatefulSetList           | items.spec.template.spec | io.k8s.api.core.v1.PodSpec
    io.k8s.api.apps.v1.StatefulSetSpec           | template.spec            | io.k8s.api.core.v1.PodSpec
    io.k8s.api.batch.v1.Job                      | spec.template.spec       | io.k8s.api.core.v1.PodSpec
    io.k8s.api.batch.v1.JobList                  | items.spec.template.spec | io.k8s.api.core.v1.PodSpec
    io.k8s.api.batch.v1.JobSpec                  | template.spec            | io.k8s.api.core.v1.PodSpec
    io.k8s.api.core.v1.PodList                   | items.spec               | io.k8s.api.core.v1.PodSpec
    io.k8s.api.core.v1.PodTemplate               | template.spec            | io.k8s.api.core.v1.PodSpec
    io.k8s.api.core.v1.PodTemplateList           | items.template.spec      | io.k8s.api.core.v1.PodSpec
    io.k8s.api.core.v1.ReplicationController     | spec.template.spec       | io.k8s.api.core.v1.PodSpec
    io.k8s.api.core.v1.ReplicationControllerList | items.spec.template.spec | io.k8s.api.core.v1.PodSpec
    io.k8s.api.core.v1.ReplicationControllerSpec | template.spec            | io.k8s.api.core.v1.PodSpec
   (21 rows)

   #+end_src

** Create kind_field_path_coverage view
   I am realizing that we could just do a join based on if the schema matches and the jsonb exists.  That's what we're looking for, so we could keep it simple.
   I think this just...might work?  We can verify by grabbing different audit_id events from the event array and searching for them specifically to do a sanity check.
   We'll do a left join to keep the fields who have no hits in this audit log.  so we can expect PodList to have 0 but PodTemplate to have like 1680.
   
   #+NAME: Count events with each of the kind scehmas.
   #+BEGIN_SRC sql-mode
     CREATE MATERIALIZED VIEW "public"."kind_field_path_coverage_material" AS
     SELECT
       f.kind,
       f.field_path,
       f.field_kind,
       ae.audit_id as audit_event_id
       FROM fieldwork f
           LEFT JOIN LATERAL (select * from audit_event WHERE param_schema = f.kind AND jsonb_path_exists(request_object, ('$.'||f.field_path)::jsonpath)) ae ON true
       GROUP BY f.kind, f.field_path, f.field_kind; 
   #+END_SRC
   
   #+NAME: kind_field_path_coverage view
   #+BEGIN_SRC sql-mode
     CREATE OR REPLACE VIEW "public"."kind_field_path_coverage" AS
     SELECT * from kind_field_path_coverage_material;
   #+END_SRC

   #+RESULTS: kind_field_path_coverage view
   #+begin_src sql-mode
   CREATE VIEW
   #+end_src


   #+RESULTS: Count events with each of the kind scehmas.
   #+begin_src sql-mode
   SELECT 67
   #+end_src
   
   #+BEGIN_SRC sql-mode
   select kind, field_path, field_kind, hits, test_hits, conf_hits from kind_field_path_coverage;
   #+END_SRC

   #+RESULTS:
   #+begin_src sql-mode
                        kind                     |               field_path                |          field_kind          | hits  | test_hits | conf_hits 
   ----------------------------------------------+-----------------------------------------+------------------------------+-------+-----------+-----------
    io.k8s.api.apps.v1.DaemonSet                 | spec.template.spec                      | io.k8s.api.core.v1.PodSpec   |   258 |        40 |         0
    io.k8s.api.apps.v1.DaemonSet                 | spec.template.spec.containers           | io.k8s.api.core.v1.Container |   258 |        40 |         0
    io.k8s.api.apps.v1.DaemonSet                 | spec.template.spec.initContainers       | io.k8s.api.core.v1.Container |     0 |         0 |         0
    io.k8s.api.apps.v1.DaemonSetList             | items.spec.template.spec                | io.k8s.api.core.v1.PodSpec   |     0 |         0 |         0
    io.k8s.api.apps.v1.DaemonSetList             | items.spec.template.spec.containers     | io.k8s.api.core.v1.Container |     0 |         0 |         0
    io.k8s.api.apps.v1.DaemonSetList             | items.spec.template.spec.initContainers | io.k8s.api.core.v1.Container |     0 |         0 |         0
    io.k8s.api.apps.v1.DaemonSetSpec             | template.spec                           | io.k8s.api.core.v1.PodSpec   |     0 |         0 |         0
    io.k8s.api.apps.v1.DaemonSetSpec             | template.spec.containers                | io.k8s.api.core.v1.Container |     0 |         0 |         0
    io.k8s.api.apps.v1.DaemonSetSpec             | template.spec.initContainers            | io.k8s.api.core.v1.Container |     0 |         0 |         0
    io.k8s.api.apps.v1.Deployment                | spec.template.spec                      | io.k8s.api.core.v1.PodSpec   |  2488 |       220 |       124
    io.k8s.api.apps.v1.Deployment                | spec.template.spec.containers           | io.k8s.api.core.v1.Container |  2488 |       220 |       124
    io.k8s.api.apps.v1.Deployment                | spec.template.spec.initContainers       | io.k8s.api.core.v1.Container |     0 |         0 |         0
    io.k8s.api.apps.v1.DeploymentList            | items.spec.template.spec                | io.k8s.api.core.v1.PodSpec   |     0 |         0 |         0
    io.k8s.api.apps.v1.DeploymentList            | items.spec.template.spec.containers     | io.k8s.api.core.v1.Container |     0 |         0 |         0
    io.k8s.api.apps.v1.DeploymentList            | items.spec.template.spec.initContainers | io.k8s.api.core.v1.Container |     0 |         0 |         0
    io.k8s.api.apps.v1.DeploymentSpec            | template.spec                           | io.k8s.api.core.v1.PodSpec   |     0 |         0 |         0
    io.k8s.api.apps.v1.DeploymentSpec            | template.spec.containers                | io.k8s.api.core.v1.Container |     0 |         0 |         0
    io.k8s.api.apps.v1.DeploymentSpec            | template.spec.initContainers            | io.k8s.api.core.v1.Container |     0 |         0 |         0
    io.k8s.api.apps.v1.ReplicaSet                | spec.template.spec                      | io.k8s.api.core.v1.PodSpec   |  3006 |        72 |        24
    io.k8s.api.apps.v1.ReplicaSet                | spec.template.spec.containers           | io.k8s.api.core.v1.Container |  3006 |        72 |        24
    io.k8s.api.apps.v1.ReplicaSet                | spec.template.spec.initContainers       | io.k8s.api.core.v1.Container |     0 |         0 |         0
    io.k8s.api.apps.v1.ReplicaSetList            | items.spec.template.spec                | io.k8s.api.core.v1.PodSpec   |     0 |         0 |         0
    io.k8s.api.apps.v1.ReplicaSetList            | items.spec.template.spec.containers     | io.k8s.api.core.v1.Container |     0 |         0 |         0
    io.k8s.api.apps.v1.ReplicaSetList            | items.spec.template.spec.initContainers | io.k8s.api.core.v1.Container |     0 |         0 |         0
    io.k8s.api.apps.v1.ReplicaSetSpec            | template.spec                           | io.k8s.api.core.v1.PodSpec   |     0 |         0 |         0
    io.k8s.api.apps.v1.ReplicaSetSpec            | template.spec.containers                | io.k8s.api.core.v1.Container |     0 |         0 |         0
    io.k8s.api.apps.v1.ReplicaSetSpec            | template.spec.initContainers            | io.k8s.api.core.v1.Container |     0 |         0 |         0
    io.k8s.api.apps.v1.StatefulSet               | spec.template.spec                      | io.k8s.api.core.v1.PodSpec   |  3124 |       776 |        56
    io.k8s.api.apps.v1.StatefulSet               | spec.template.spec.containers           | io.k8s.api.core.v1.Container |  3124 |       776 |        56
    io.k8s.api.apps.v1.StatefulSet               | spec.template.spec.initContainers       | io.k8s.api.core.v1.Container |     0 |         0 |         0
    io.k8s.api.apps.v1.StatefulSetList           | items.spec.template.spec                | io.k8s.api.core.v1.PodSpec   |     0 |         0 |         0
    io.k8s.api.apps.v1.StatefulSetList           | items.spec.template.spec.containers     | io.k8s.api.core.v1.Container |     0 |         0 |         0
    io.k8s.api.apps.v1.StatefulSetList           | items.spec.template.spec.initContainers | io.k8s.api.core.v1.Container |     0 |         0 |         0
    io.k8s.api.apps.v1.StatefulSetSpec           | template.spec                           | io.k8s.api.core.v1.PodSpec   |     0 |         0 |         0
    io.k8s.api.apps.v1.StatefulSetSpec           | template.spec.containers                | io.k8s.api.core.v1.Container |     0 |         0 |         0
    io.k8s.api.apps.v1.StatefulSetSpec           | template.spec.initContainers            | io.k8s.api.core.v1.Container |     0 |         0 |         0
    io.k8s.api.batch.v1.Job                      | spec.template.spec                      | io.k8s.api.core.v1.PodSpec   |   358 |        36 |        12
    io.k8s.api.batch.v1.Job                      | spec.template.spec.containers           | io.k8s.api.core.v1.Container |   358 |        36 |        12
    io.k8s.api.batch.v1.Job                      | spec.template.spec.initContainers       | io.k8s.api.core.v1.Container |     0 |         0 |         0
    io.k8s.api.batch.v1.JobList                  | items.spec.template.spec                | io.k8s.api.core.v1.PodSpec   |     0 |         0 |         0
    io.k8s.api.batch.v1.JobList                  | items.spec.template.spec.containers     | io.k8s.api.core.v1.Container |     0 |         0 |         0
    io.k8s.api.batch.v1.JobList                  | items.spec.template.spec.initContainers | io.k8s.api.core.v1.Container |     0 |         0 |         0
    io.k8s.api.batch.v1.JobSpec                  | template.spec                           | io.k8s.api.core.v1.PodSpec   |     0 |         0 |         0
    io.k8s.api.batch.v1.JobSpec                  | template.spec.containers                | io.k8s.api.core.v1.Container |     0 |         0 |         0
    io.k8s.api.batch.v1.JobSpec                  | template.spec.initContainers            | io.k8s.api.core.v1.Container |     0 |         0 |         0
    io.k8s.api.core.v1.Pod                       | spec.containers                         | io.k8s.api.core.v1.Container | 10296 |      3968 |       900
    io.k8s.api.core.v1.Pod                       | spec.initContainers                     | io.k8s.api.core.v1.Container |   452 |       452 |        16
    io.k8s.api.core.v1.PodList                   | items.spec                              | io.k8s.api.core.v1.PodSpec   |     0 |         0 |         0
    io.k8s.api.core.v1.PodList                   | items.spec.containers                   | io.k8s.api.core.v1.Container |     0 |         0 |         0
    io.k8s.api.core.v1.PodList                   | items.spec.initContainers               | io.k8s.api.core.v1.Container |     0 |         0 |         0
    io.k8s.api.core.v1.PodTemplate               | template.spec                           | io.k8s.api.core.v1.PodSpec   |  1680 |      1680 |         0
    io.k8s.api.core.v1.PodTemplate               | template.spec.containers                | io.k8s.api.core.v1.Container |  1680 |      1680 |         0
    io.k8s.api.core.v1.PodTemplate               | template.spec.initContainers            | io.k8s.api.core.v1.Container |     0 |         0 |         0
    io.k8s.api.core.v1.PodTemplateList           | items.template.spec                     | io.k8s.api.core.v1.PodSpec   |     0 |         0 |         0
    io.k8s.api.core.v1.PodTemplateList           | items.template.spec.containers          | io.k8s.api.core.v1.Container |     0 |         0 |         0
    io.k8s.api.core.v1.PodTemplateList           | items.template.spec.initContainers      | io.k8s.api.core.v1.Container |     0 |         0 |         0
    io.k8s.api.core.v1.PodTemplateSpec           | spec.containers                         | io.k8s.api.core.v1.Container |     0 |         0 |         0
    io.k8s.api.core.v1.PodTemplateSpec           | spec.initContainers                     | io.k8s.api.core.v1.Container |     0 |         0 |         0
    io.k8s.api.core.v1.ReplicationController     | spec.template.spec                      | io.k8s.api.core.v1.PodSpec   |  1334 |       144 |        72
    io.k8s.api.core.v1.ReplicationController     | spec.template.spec.containers           | io.k8s.api.core.v1.Container |  1334 |       144 |        72
    io.k8s.api.core.v1.ReplicationController     | spec.template.spec.initContainers       | io.k8s.api.core.v1.Container |     0 |         0 |         0
    io.k8s.api.core.v1.ReplicationControllerList | items.spec.template.spec                | io.k8s.api.core.v1.PodSpec   |     0 |         0 |         0
    io.k8s.api.core.v1.ReplicationControllerList | items.spec.template.spec.containers     | io.k8s.api.core.v1.Container |     0 |         0 |         0
    io.k8s.api.core.v1.ReplicationControllerList | items.spec.template.spec.initContainers | io.k8s.api.core.v1.Container |     0 |         0 |         0
    io.k8s.api.core.v1.ReplicationControllerSpec | template.spec                           | io.k8s.api.core.v1.PodSpec   |     0 |         0 |         0
    io.k8s.api.core.v1.ReplicationControllerSpec | template.spec.containers                | io.k8s.api.core.v1.Container |     0 |         0 |         0
    io.k8s.api.core.v1.ReplicationControllerSpec | template.spec.initContainers            | io.k8s.api.core.v1.Container |     0 |         0 |         0
   (67 rows)

   #+end_src

   
HUZZAH IT WORKS!

** extend fieldwork to include containers 
   what does it look like if we don't limit to just podspec field?  Does it still run in a reasonable amount of time?
 
   #+NAME: Extended Fieldwork 
   #+BEGIN_SRC sql-mode
   CREATE OR REPLACE VIEW "public"."fieldwork" AS
     select
       distinct kind, field_path, field_kind, bucket, job
       from kind_field_path_recursion
      where
     kind not like '%alpha%'
     and kind not like '%beta%'
     -- and field_kind = ANY('{"io.k8s.api.core.v1.PodSpec", "io.k8s.api.core.v1.Container"}')
     and field_path like '%.%'
     and field_path not like 'volumes%';
   #+END_SRC

   #+RESULTS: Extended Fieldwork
   #+begin_src sql-mode
   CREATE VIEW
   #+end_src
   

   #+RESULTS:
   #+begin_src sql-mode
                        kind                     |               field_path                | hits  | test_hits | conf_hits 
   ----------------------------------------------+-----------------------------------------+-------+-----------+-----------
    io.k8s.api.core.v1.PodList                   | items.spec                              |     0 |         0 |         0
    io.k8s.api.core.v1.PodList                   | items.spec.containers                   |     0 |         0 |         0
    io.k8s.api.core.v1.PodList                   | items.spec.initContainers               |     0 |         0 |         0
    io.k8s.api.apps.v1.DaemonSetList             | items.spec.template.spec                |     0 |         0 |         0
    io.k8s.api.apps.v1.ReplicaSetList            | items.spec.template.spec                |     0 |         0 |         0
    io.k8s.api.batch.v1.JobList                  | items.spec.template.spec                |     0 |         0 |         0
    io.k8s.api.apps.v1.StatefulSetList           | items.spec.template.spec                |     0 |         0 |         0
    io.k8s.api.apps.v1.DeploymentList            | items.spec.template.spec                |     0 |         0 |         0
    io.k8s.api.core.v1.ReplicationControllerList | items.spec.template.spec                |     0 |         0 |         0
    io.k8s.api.apps.v1.StatefulSetList           | items.spec.template.spec.containers     |     0 |         0 |         0
    io.k8s.api.core.v1.ReplicationControllerList | items.spec.template.spec.containers     |     0 |         0 |         0
    io.k8s.api.apps.v1.DeploymentList            | items.spec.template.spec.containers     |     0 |         0 |         0
    io.k8s.api.batch.v1.JobList                  | items.spec.template.spec.containers     |     0 |         0 |         0
    io.k8s.api.apps.v1.DaemonSetList             | items.spec.template.spec.containers     |     0 |         0 |         0
    io.k8s.api.apps.v1.ReplicaSetList            | items.spec.template.spec.containers     |     0 |         0 |         0
    io.k8s.api.apps.v1.DeploymentList            | items.spec.template.spec.initContainers |     0 |         0 |         0
    io.k8s.api.core.v1.ReplicationControllerList | items.spec.template.spec.initContainers |     0 |         0 |         0
    io.k8s.api.apps.v1.StatefulSetList           | items.spec.template.spec.initContainers |     0 |         0 |         0
    io.k8s.api.batch.v1.JobList                  | items.spec.template.spec.initContainers |     0 |         0 |         0
    io.k8s.api.apps.v1.DaemonSetList             | items.spec.template.spec.initContainers |     0 |         0 |         0
    io.k8s.api.apps.v1.ReplicaSetList            | items.spec.template.spec.initContainers |     0 |         0 |         0
    io.k8s.api.core.v1.PodTemplateList           | items.template.spec                     |     0 |         0 |         0
    io.k8s.api.core.v1.PodTemplateList           | items.template.spec.containers          |     0 |         0 |         0
    io.k8s.api.core.v1.PodTemplateList           | items.template.spec.initContainers      |     0 |         0 |         0
    io.k8s.api.core.v1.PodTemplateSpec           | spec.containers                         |     0 |         0 |         0
    io.k8s.api.core.v1.Pod                       | spec.containers                         | 10296 |      3968 |       900
    io.k8s.api.core.v1.Pod                       | spec.initContainers                     |   452 |       452 |        16
    io.k8s.api.core.v1.PodTemplateSpec           | spec.initContainers                     |     0 |         0 |         0
    io.k8s.api.apps.v1.DaemonSet                 | spec.template.spec                      |   258 |        40 |         0
    io.k8s.api.apps.v1.ReplicaSet                | spec.template.spec                      |  3006 |        72 |        24
    io.k8s.api.batch.v1.Job                      | spec.template.spec                      |   358 |        36 |        12
    io.k8s.api.apps.v1.StatefulSet               | spec.template.spec                      |  3124 |       776 |        56
    io.k8s.api.apps.v1.Deployment                | spec.template.spec                      |  2488 |       220 |       124
    io.k8s.api.core.v1.ReplicationController     | spec.template.spec                      |  1334 |       144 |        72
    io.k8s.api.batch.v1.Job                      | spec.template.spec.containers           |   358 |        36 |        12
    io.k8s.api.core.v1.ReplicationController     | spec.template.spec.containers           |  1334 |       144 |        72
    io.k8s.api.apps.v1.ReplicaSet                | spec.template.spec.containers           |  3006 |        72 |        24
    io.k8s.api.apps.v1.StatefulSet               | spec.template.spec.containers           |  3124 |       776 |        56
    io.k8s.api.apps.v1.Deployment                | spec.template.spec.containers           |  2488 |       220 |       124
    io.k8s.api.apps.v1.DaemonSet                 | spec.template.spec.containers           |   258 |        40 |         0
    io.k8s.api.apps.v1.DaemonSet                 | spec.template.spec.initContainers       |     0 |         0 |         0
    io.k8s.api.apps.v1.Deployment                | spec.template.spec.initContainers       |     0 |         0 |         0
    io.k8s.api.apps.v1.StatefulSet               | spec.template.spec.initContainers       |     0 |         0 |         0
    io.k8s.api.apps.v1.ReplicaSet                | spec.template.spec.initContainers       |     0 |         0 |         0
    io.k8s.api.batch.v1.Job                      | spec.template.spec.initContainers       |     0 |         0 |         0
    io.k8s.api.core.v1.ReplicationController     | spec.template.spec.initContainers       |     0 |         0 |         0
    io.k8s.api.core.v1.PodTemplate               | template.spec                           |  1680 |      1680 |         0
    io.k8s.api.apps.v1.DaemonSetSpec             | template.spec                           |     0 |         0 |         0
    io.k8s.api.apps.v1.DeploymentSpec            | template.spec                           |     0 |         0 |         0
    io.k8s.api.apps.v1.ReplicaSetSpec            | template.spec                           |     0 |         0 |         0
    io.k8s.api.apps.v1.StatefulSetSpec           | template.spec                           |     0 |         0 |         0
    io.k8s.api.batch.v1.JobSpec                  | template.spec                           |     0 |         0 |         0
    io.k8s.api.core.v1.ReplicationControllerSpec | template.spec                           |     0 |         0 |         0
    io.k8s.api.apps.v1.StatefulSetSpec           | template.spec.containers                |     0 |         0 |         0
    io.k8s.api.apps.v1.DeploymentSpec            | template.spec.containers                |     0 |         0 |         0
    io.k8s.api.batch.v1.JobSpec                  | template.spec.containers                |     0 |         0 |         0
    io.k8s.api.apps.v1.DaemonSetSpec             | template.spec.containers                |     0 |         0 |         0
    io.k8s.api.apps.v1.ReplicaSetSpec            | template.spec.containers                |     0 |         0 |         0
    io.k8s.api.core.v1.ReplicationControllerSpec | template.spec.containers                |     0 |         0 |         0
    io.k8s.api.core.v1.PodTemplate               | template.spec.containers                |  1680 |      1680 |         0
    io.k8s.api.core.v1.PodTemplate               | template.spec.initContainers            |     0 |         0 |         0
    io.k8s.api.batch.v1.JobSpec                  | template.spec.initContainers            |     0 |         0 |         0
    io.k8s.api.apps.v1.StatefulSetSpec           | template.spec.initContainers            |     0 |         0 |         0
    io.k8s.api.apps.v1.ReplicaSetSpec            | template.spec.initContainers            |     0 |         0 |         0
    io.k8s.api.apps.v1.DeploymentSpec            | template.spec.initContainers            |     0 |         0 |         0
    io.k8s.api.apps.v1.DaemonSetSpec             | template.spec.initContainers            |     0 |         0 |         0
    io.k8s.api.core.v1.ReplicationControllerSpec | template.spec.initContainers            |     0 |         0 |         0
   (67 rows)

   #+end_src
** Investigating / validating the numbers
*** Survey of kind and field_path coverage   
   If we take a look at the coverage organized by field_path, the big gaps in coverage become clear.  
   #+NAME: kind coverage ordered by field_path
   #+BEGIN_SRC sql-mode
select kind, field_path, hits, test_hits, conf_hits from kind_field_path_coverage order by field_path;
   #+END_SRC

   #+RESULTS: kind coverage ordered by field_path
   #+begin_src sql-mode
                        kind                     |               field_path                | hits  | test_hits | conf_hits 
   ----------------------------------------------+-----------------------------------------+-------+-----------+-----------
    io.k8s.api.core.v1.PodList                   | items.spec                              |     0 |         0 |         0
    io.k8s.api.core.v1.PodList                   | items.spec.containers                   |     0 |         0 |         0
    io.k8s.api.core.v1.PodList                   | items.spec.initContainers               |     0 |         0 |         0
    io.k8s.api.apps.v1.DaemonSetList             | items.spec.template.spec                |     0 |         0 |         0
    io.k8s.api.apps.v1.ReplicaSetList            | items.spec.template.spec                |     0 |         0 |         0
    io.k8s.api.batch.v1.JobList                  | items.spec.template.spec                |     0 |         0 |         0
    io.k8s.api.apps.v1.StatefulSetList           | items.spec.template.spec                |     0 |         0 |         0
    io.k8s.api.apps.v1.DeploymentList            | items.spec.template.spec                |     0 |         0 |         0
    io.k8s.api.core.v1.ReplicationControllerList | items.spec.template.spec                |     0 |         0 |         0
    io.k8s.api.apps.v1.StatefulSetList           | items.spec.template.spec.containers     |     0 |         0 |         0
    io.k8s.api.core.v1.ReplicationControllerList | items.spec.template.spec.containers     |     0 |         0 |         0
    io.k8s.api.apps.v1.DeploymentList            | items.spec.template.spec.containers     |     0 |         0 |         0
    io.k8s.api.batch.v1.JobList                  | items.spec.template.spec.containers     |     0 |         0 |         0
    io.k8s.api.apps.v1.DaemonSetList             | items.spec.template.spec.containers     |     0 |         0 |         0
    io.k8s.api.apps.v1.ReplicaSetList            | items.spec.template.spec.containers     |     0 |         0 |         0
    io.k8s.api.apps.v1.DeploymentList            | items.spec.template.spec.initContainers |     0 |         0 |         0
    io.k8s.api.core.v1.ReplicationControllerList | items.spec.template.spec.initContainers |     0 |         0 |         0
    io.k8s.api.apps.v1.StatefulSetList           | items.spec.template.spec.initContainers |     0 |         0 |         0
    io.k8s.api.batch.v1.JobList                  | items.spec.template.spec.initContainers |     0 |         0 |         0
    io.k8s.api.apps.v1.DaemonSetList             | items.spec.template.spec.initContainers |     0 |         0 |         0
    io.k8s.api.apps.v1.ReplicaSetList            | items.spec.template.spec.initContainers |     0 |         0 |         0
    io.k8s.api.core.v1.PodTemplateList           | items.template.spec                     |     0 |         0 |         0
    io.k8s.api.core.v1.PodTemplateList           | items.template.spec.containers          |     0 |         0 |         0
    ie.k8s.api.core.v1.PodTemplateList           | items.template.spec.initContainers      |     0 |         0 |         0
    io.k8s.api.core.v1.PodTemplateSpec           | spec.containers                         |     0 |         0 |         0
    io.k8s.api.core.v1.Pod                       | spec.containers                         | 10296 |      3968 |       900
    io.k8s.api.core.v1.Pod                       | spec.initContainers                     |   452 |       452 |        16
    io.k8s.api.core.v1.PodTemplateSpec           | spec.initContainers                     |     0 |         0 |         0
    io.k8s.api.apps.v1.DaemonSet                 | spec.template.spec                      |   258 |        40 |         0
    io.k8s.api.apps.v1.ReplicaSet                | spec.template.spec                      |  3006 |        72 |        24
    io.k8s.api.batch.v1.Job                      | spec.template.spec                      |   358 |        36 |        12
    io.k8s.api.apps.v1.StatefulSet               | spec.template.spec                      |  3124 |       776 |        56
    io.k8s.api.apps.v1.Deployment                | spec.template.spec                      |  2488 |       220 |       124
    io.k8s.api.core.v1.ReplicationController     | spec.template.spec                      |  1334 |       144 |        72
    io.k8s.api.batch.v1.Job                      | spec.template.spec.containers           |   358 |        36 |        12
    io.k8s.api.core.v1.ReplicationController     | spec.template.spec.containers           |  1334 |       144 |        72
    io.k8s.api.apps.v1.ReplicaSet                | spec.template.spec.containers           |  3006 |        72 |        24
    io.k8s.api.apps.v1.StatefulSet               | spec.template.spec.containers           |  3124 |       776 |        56
    io.k8s.api.apps.v1.Deployment                | spec.template.spec.containers           |  2488 |       220 |       124
    io.k8s.api.apps.v1.DaemonSet                 | spec.template.spec.containers           |   258 |        40 |         0
    io.k8s.api.apps.v1.DaemonSet                 | spec.template.spec.initContainers       |     0 |         0 |         0
    io.k8s.api.apps.v1.Deployment                | spec.template.spec.initContainers       |     0 |         0 |         0
    io.k8s.api.apps.v1.StatefulSet               | spec.template.spec.initContainers       |     0 |         0 |         0
    io.k8s.api.apps.v1.ReplicaSet                | spec.template.spec.initContainers       |     0 |         0 |         0
    io.k8s.api.batch.v1.Job                      | spec.template.spec.initContainers       |     0 |         0 |         0
    io.k8s.api.core.v1.ReplicationController     | spec.template.spec.initContainers       |     0 |         0 |         0
    io.k8s.api.core.v1.PodTemplate               | template.spec                           |  1680 |      1680 |         0
    io.k8s.api.apps.v1.DaemonSetSpec             | template.spec                           |     0 |         0 |         0
    io.k8s.api.apps.v1.DeploymentSpec            | template.spec                           |     0 |         0 |         0
    io.k8s.api.apps.v1.ReplicaSetSpec            | template.spec                           |     0 |         0 |         0
    io.k8s.api.apps.v1.StatefulSetSpec           | template.spec                           |     0 |         0 |         0
    io.k8s.api.batch.v1.JobSpec                  | template.spec                           |     0 |         0 |         0
    io.k8s.api.core.v1.ReplicationControllerSpec | template.spec                           |     0 |         0 |         0
    io.k8s.api.apps.v1.StatefulSetSpec           | template.spec.containers                |     0 |         0 |         0
    io.k8s.api.apps.v1.DeploymentSpec            | template.spec.containers                |     0 |         0 |         0
    io.k8s.api.batch.v1.JobSpec                  | template.spec.containers                |     0 |         0 |         0
    io.k8s.api.apps.v1.DaemonSetSpec             | template.spec.containers                |     0 |         0 |         0
    io.k8s.api.apps.v1.ReplicaSetSpec            | template.spec.containers                |     0 |         0 |         0
    io.k8s.api.core.v1.ReplicationControllerSpec | template.spec.containers                |     0 |         0 |         0
    io.k8s.api.core.v1.PodTemplate               | template.spec.containers                |  1680 |      1680 |         0
    io.k8s.api.core.v1.PodTemplate               | template.spec.initContainers            |     0 |         0 |         0
    io.k8s.api.batch.v1.JobSpec                  | template.spec.initContainers            |     0 |         0 |         0
    io.k8s.api.apps.v1.StatefulSetSpec           | template.spec.initContainers            |     0 |         0 |         0
    io.k8s.api.apps.v1.ReplicaSetSpec            | template.spec.initContainers            |     0 |         0 |         0
    io.k8s.api.apps.v1.DeploymentSpec            | template.spec.initContainers            |     0 |         0 |         0
    io.k8s.api.apps.v1.DaemonSetSpec             | template.spec.initContainers            |     0 |         0 |         0
    io.k8s.api.core.v1.ReplicationControllerSpec | template.spec.initContainers            |     0 |         0 |         0
   (67 rows)

   #+end_src
   
   There are no audit_events with items.spec in their request object that are hit at all.  All the field_paths that start with spec are hit, except ~spec.template.spec.initContainers~, and the podTemplate kind with fieldpath ~template.spec~ and ~template.spec.containers~ are hit, but the other ~template.spec~ field paths are not hit at all.  Is this an accurate look at coverage, or misunderstanding the relation between the field path and our audit events?
   
   The definition of field_path in the original table we draw from comes from [[file:~/ii/apisnoop/org/tables_and_views.org::*400:%20kind_field_path_recursion][400: kind_field_path_recursion]].  In short: we grab the field_name from api_schema_field and recursively build a path as we traverse the schema of that field name.

The field name is generated in [[file:~/ii/apisnoop/org/tables_and_views.org::*260:%20api_schema_field%20view][260: api_schema_field view]].  Here we look at our api_schema field, and add a record for each object within the schema properties, with the property key becoming 'field_name'.

There's a renaming here (schema property to field name), but that is going to happen when comparing our logs to the openapi spec, and it's one we discussed when constructing these field views originally and so i feel okay with that change.  The question for me is whether items.spec are represented in a different way in the event that wont' be captured by simply looking for a json path.
   
Another thing to look at is the kinds that aren't hit at all.  There's a pattern here, too, where the template or top-level kind is hit, but the spec kinds are not.

#+NAME: kind_field_path_coverage ordered by kind
   #+BEGIN_SRC sql-mode
select kind, field_path, hits, test_hits, conf_hits from kind_field_path_coverage order by kind;
   #+END_SRC

   #+RESULTS: kind_field_path_coverage ordered by kind
   #+begin_src sql-mode
                        kind                     |               field_path                | hits  | test_hits | conf_hits 
   ----------------------------------------------+-----------------------------------------+-------+-----------+-----------
    io.k8s.api.apps.v1.DaemonSet                 | spec.template.spec                      |   258 |        40 |         0
    io.k8s.api.apps.v1.DaemonSet                 | spec.template.spec.containers           |   258 |        40 |         0
    io.k8s.api.apps.v1.DaemonSet                 | spec.template.spec.initContainers       |     0 |         0 |         0
    io.k8s.api.apps.v1.DaemonSetList             | items.spec.template.spec                |     0 |         0 |         0
    io.k8s.api.apps.v1.DaemonSetList             | items.spec.template.spec.containers     |     0 |         0 |         0
    io.k8s.api.apps.v1.DaemonSetList             | items.spec.template.spec.initContainers |     0 |         0 |         0
    io.k8s.api.apps.v1.DaemonSetSpec             | template.spec                           |     0 |         0 |         0
    io.k8s.api.apps.v1.DaemonSetSpec             | template.spec.containers                |     0 |         0 |         0
    io.k8s.api.apps.v1.DaemonSetSpec             | template.spec.initContainers            |     0 |         0 |         0
    io.k8s.api.apps.v1.Deployment                | spec.template.spec                      |  2488 |       220 |       124
    io.k8s.api.apps.v1.Deployment                | spec.template.spec.containers           |  2488 |       220 |       124
    io.k8s.api.apps.v1.Deployment                | spec.template.spec.initContainers       |     0 |         0 |         0
    io.k8s.api.apps.v1.DeploymentList            | items.spec.template.spec                |     0 |         0 |         0
    io.k8s.api.apps.v1.DeploymentList            | items.spec.template.spec.containers     |     0 |         0 |         0
    io.k8s.api.apps.v1.DeploymentList            | items.spec.template.spec.initContainers |     0 |         0 |         0
    io.k8s.api.apps.v1.DeploymentSpec            | template.spec                           |     0 |         0 |         0
    io.k8s.api.apps.v1.DeploymentSpec            | template.spec.containers                |     0 |         0 |         0
    io.k8s.api.apps.v1.DeploymentSpec            | template.spec.initContainers            |     0 |         0 |         0
    io.k8s.api.apps.v1.ReplicaSet                | spec.template.spec                      |  3006 |        72 |        24
    io.k8s.api.apps.v1.ReplicaSet                | spec.template.spec.containers           |  3006 |        72 |        24
    io.k8s.api.apps.v1.ReplicaSet                | spec.template.spec.initContainers       |     0 |         0 |         0
    io.k8s.api.apps.v1.ReplicaSetList            | items.spec.template.spec                |     0 |         0 |         0
    io.k8s.api.apps.v1.ReplicaSetList            | items.spec.template.spec.containers     |     0 |         0 |         0
    io.k8s.api.apps.v1.ReplicaSetList            | items.spec.template.spec.initContainers |     0 |         0 |         0
    io.k8s.api.apps.v1.ReplicaSetSpec            | template.spec                           |     0 |         0 |         0
    io.k8s.api.apps.v1.ReplicaSetSpec            | template.spec.containers                |     0 |         0 |         0
    io.k8s.api.apps.v1.ReplicaSetSpec            | template.spec.initContainers            |     0 |         0 |         0
    io.k8s.api.apps.v1.StatefulSet               | spec.template.spec                      |  3124 |       776 |        56
    io.k8s.api.apps.v1.StatefulSet               | spec.template.spec.containers           |  3124 |       776 |        56
    io.k8s.api.apps.v1.StatefulSet               | spec.template.spec.initContainers       |     0 |         0 |         0
    io.k8s.api.apps.v1.StatefulSetList           | items.spec.template.spec                |     0 |         0 |         0
    io.k8s.api.apps.v1.StatefulSetList           | items.spec.template.spec.containers     |     0 |         0 |         0
    io.k8s.api.apps.v1.StatefulSetList           | items.spec.template.spec.initContainers |     0 |         0 |         0
    io.k8s.api.apps.v1.StatefulSetSpec           | template.spec                           |     0 |         0 |         0
    io.k8s.api.apps.v1.StatefulSetSpec           | template.spec.containers                |     0 |         0 |         0
    io.k8s.api.apps.v1.StatefulSetSpec           | template.spec.initContainers            |     0 |         0 |         0
    io.k8s.api.batch.v1.Job                      | spec.template.spec                      |   358 |        36 |        12
    io.k8s.api.batch.v1.Job                      | spec.template.spec.containers           |   358 |        36 |        12
    io.k8s.api.batch.v1.Job                      | spec.template.spec.initContainers       |     0 |         0 |         0
    io.k8s.api.batch.v1.JobList                  | items.spec.template.spec                |     0 |         0 |         0
    io.k8s.api.batch.v1.JobList                  | items.spec.template.spec.containers     |     0 |         0 |         0
    io.k8s.api.batch.v1.JobList                  | items.spec.template.spec.initContainers |     0 |         0 |         0
    io.k8s.api.batch.v1.JobSpec                  | template.spec                           |     0 |         0 |         0
    io.k8s.api.batch.v1.JobSpec                  | template.spec.containers                |     0 |         0 |         0
    io.k8s.api.batch.v1.JobSpec                  | template.spec.initContainers            |     0 |         0 |         0
    io.k8s.api.core.v1.Pod                       | spec.containers                         | 10296 |      3968 |       900
    io.k8s.api.core.v1.Pod                       | spec.initContainers                     |   452 |       452 |        16
    io.k8s.api.core.v1.PodList                   | items.spec                              |     0 |         0 |         0
    io.k8s.api.core.v1.PodList                   | items.spec.containers                   |     0 |         0 |         0
    io.k8s.api.core.v1.PodList                   | items.spec.initContainers               |     0 |         0 |         0
    io.k8s.api.core.v1.PodTemplate               | template.spec                           |  1680 |      1680 |         0
    io.k8s.api.core.v1.PodTemplate               | template.spec.containers                |  1680 |      1680 |         0
    io.k8s.api.core.v1.PodTemplate               | template.spec.initContainers            |     0 |         0 |         0
    io.k8s.api.core.v1.PodTemplateList           | items.template.spec                     |     0 |         0 |         0
    io.k8s.api.core.v1.PodTemplateList           | items.template.spec.containers          |     0 |         0 |         0
    io.k8s.api.core.v1.PodTemplateList           | items.template.spec.initContainers      |     0 |         0 |         0
    io.k8s.api.core.v1.PodTemplateSpec           | spec.containers                         |     0 |         0 |         0
    io.k8s.api.core.v1.PodTemplateSpec           | spec.initContainers                     |     0 |         0 |         0
    io.k8s.api.core.v1.ReplicationController     | spec.template.spec                      |  1334 |       144 |        72
    io.k8s.api.core.v1.ReplicationController     | spec.template.spec.containers           |  1334 |       144 |        72
    io.k8s.api.core.v1.ReplicationController     | spec.template.spec.initContainers       |     0 |         0 |         0
    io.k8s.api.core.v1.ReplicationControllerList | items.spec.template.spec                |     0 |         0 |         0
    io.k8s.api.core.v1.ReplicationControllerList | items.spec.template.spec.containers     |     0 |         0 |         0
    io.k8s.api.core.v1.ReplicationControllerList | items.spec.template.spec.initContainers |     0 |         0 |         0
    io.k8s.api.core.v1.ReplicationControllerSpec | template.spec                           |     0 |         0 |         0
    io.k8s.api.core.v1.ReplicationControllerSpec | template.spec.containers                |     0 |         0 |         0
    io.k8s.api.core.v1.ReplicationControllerSpec | template.spec.initContainers            |     0 |         0 |         0
   (67 rows)

   #+end_src
   
   The consistency here makes me think it's not about a lack of coverage, but that we aren't capturing when these ..subkinds...(maybe not the right term) are hit.  Pod will be hit, PodList will not.  ReplicationController will be hit, ReplicationControllerList will not.  What is the relation here?
   
*** Look into a Single Kind/Field_Path and it's audit events
    Another validation we can do is to just check the return audit events and ensure their request object has what we think it should.
    We can grab a single audit event through an index on our events column
    #+NAME: Grabbing Third Audit Event
    #+BEGIN_SRC sql-mode
    SELECT kind, field_path, events[3] from kind_field_path_coverage where events[3] is not null;
    #+END_SRC

    #+RESULTS: Grabbing Third Audit Event
    #+begin_src sql-mode
                       kind                   |          field_path           |                events                
    ------------------------------------------+-------------------------------+--------------------------------------
     io.k8s.api.apps.v1.DaemonSet             | spec.template.spec            | 1bc6a8d5-0828-46ef-b3f7-743bf88f141a
     io.k8s.api.apps.v1.DaemonSet             | spec.template.spec.containers | 1bc6a8d5-0828-46ef-b3f7-743bf88f141a
     io.k8s.api.apps.v1.Deployment            | spec.template.spec            | 7be13ccf-d0b7-412c-8d3c-72475d817c25
     io.k8s.api.apps.v1.Deployment            | spec.template.spec.containers | 7be13ccf-d0b7-412c-8d3c-72475d817c25
     io.k8s.api.apps.v1.ReplicaSet            | spec.template.spec            | dd654c89-1a38-4410-b159-5099165fa9e5
     io.k8s.api.apps.v1.ReplicaSet            | spec.template.spec.containers | dd654c89-1a38-4410-b159-5099165fa9e5
     io.k8s.api.apps.v1.StatefulSet           | spec.template.spec            | a2f3d672-03d7-41cb-8e65-a89167f1a4f2
     io.k8s.api.apps.v1.StatefulSet           | spec.template.spec.containers | a2f3d672-03d7-41cb-8e65-a89167f1a4f2
     io.k8s.api.batch.v1.Job                  | spec.template.spec            | f2dd69ff-da7f-4c70-a600-51c0c3c4be0e
     io.k8s.api.batch.v1.Job                  | spec.template.spec.containers | f2dd69ff-da7f-4c70-a600-51c0c3c4be0e
     io.k8s.api.core.v1.Pod                   | spec.containers               | cb17d536-10ff-4c1a-9aa8-725984862f9b
     io.k8s.api.core.v1.Pod                   | spec.initContainers           | cb17d536-10ff-4c1a-9aa8-725984862f9b
     io.k8s.api.core.v1.PodTemplate           | template.spec                 | dcc8331c-f51a-4975-a3de-0dc78c63ed8d
     io.k8s.api.core.v1.PodTemplate           | template.spec.containers      | dcc8331c-f51a-4975-a3de-0dc78c63ed8d
     io.k8s.api.core.v1.ReplicationController | spec.template.spec            | 5d93e0a4-f3d5-4641-8b86-93fbce86da40
     io.k8s.api.core.v1.ReplicationController | spec.template.spec.containers | 5d93e0a4-f3d5-4641-8b86-93fbce86da40
    (16 rows)

    #+end_src

    We can now look at the request object of this audit.  ~DaemonSet~'s request object should have a json path of ~spec.template.spec.containers~
    #+BEGIN_SRC sql-mode
        SELECT events[3] as event_id
          FROM kind_field_path_coverage
                 WHERE kind = 'io.k8s.api.apps.v1.DaemonSet' AND field_path = 'spec.template.spec';
    #+END_SRC

    #+RESULTS:
    #+begin_src sql-mode
                   event_id               
    --------------------------------------
     1bc6a8d5-0828-46ef-b3f7-743bf88f141a
    (1 row)

    #+end_src

    
    #+NAME: Request Object for DaemonSet's third audit event 
    #+BEGIN_SRC sql-mode
       select 
       jsonb_pretty(request_object) 
      from audit_event where audit_id = '1bc6a8d5-0828-46ef-b3f7-743bf88f141a';
    #+END_SRC
    
    #+RESULTS: Request Object for DaemonSet's third audit event
    #+begin_src sql-mode
                                                             jsonb_pretty                                                          
    -------------------------------------------------------------------------------------------------------------------------------
     {                                                                                                                            +
         "kind": "DaemonSet",                                                                                                     +
         "spec": {                                                                                                                +
             "selector": {                                                                                                        +
                 "matchLabels": {                                                                                                 +
                     "app": "csi-hostpathplugin"                                                                                  +
                 }                                                                                                                +
             },                                                                                                                   +
             "template": {                                                                                                        +
                 "spec": {                                                                                                        +
                     "volumes": [                                                                                                 +
                         {                                                                                                        +
                             "name": "socket-dir",                                                                                +
                             "hostPath": {                                                                                        +
                                 "path": "/var/lib/kubelet/plugins/csi-hostpath-v0-provisioning-5107",                            +
                                 "type": "DirectoryOrCreate"                                                                      +
                             }                                                                                                    +
                         },                                                                                                       +
                         {                                                                                                        +
                             "name": "mountpoint-dir",                                                                            +
                             "hostPath": {                                                                                        +
                                 "path": "/var/lib/kubelet/pods",                                                                 +
                                 "type": "DirectoryOrCreate"                                                                      +
                             }                                                                                                    +
                         },                                                                                                       +
                         {                                                                                                        +
                             "name": "registration-dir",                                                                          +
                             "hostPath": {                                                                                        +
                                 "path": "/var/lib/kubelet/plugins",                                                              +
                                 "type": "Directory"                                                                              +
                             }                                                                                                    +
                         }                                                                                                        +
                     ],                                                                                                           +
                     "nodeName": "bootstrap-e2e-minion-group-8vfx",                                                               +
                     "dnsPolicy": "ClusterFirst",                                                                                 +
                     "containers": [                                                                                              +
                         {                                                                                                        +
                             "env": [                                                                                             +
                                 {                                                                                                +
                                     "name": "KUBE_NODE_NAME",                                                                    +
                                     "valueFrom": {                                                                               +
                                         "fieldRef": {                                                                            +
                                             "fieldPath": "spec.nodeName",                                                        +
                                             "apiVersion": "v1"                                                                   +
                                         }                                                                                        +
                                     }                                                                                            +
                                 }                                                                                                +
                             ],                                                                                                   +
                             "args": [                                                                                            +
                                 "--v=5",                                                                                         +
                                 "--csi-address=/csi/csi.sock",                                                                   +
                                 "--kubelet-registration-path=/var/lib/kubelet/plugins/csi-hostpath-v0-provisioning-5107/csi.sock"+
                             ],                                                                                                   +
                             "name": "driver-registrar",                                                                          +
                             "image": "quay.io/k8scsi/driver-registrar:v0.4.1",                                                   +
                             "resources": {                                                                                       +
                             },                                                                                                   +
                             "volumeMounts": [                                                                                    +
                                 {                                                                                                +
                                     "name": "socket-dir",                                                                        +
                                     "mountPath": "/csi"                                                                          +
                                 },                                                                                               +
                                 {                                                                                                +
                                     "name": "registration-dir",                                                                  +
                                     "mountPath": "/registration"                                                                 +
                                 }                                                                                                +
                             ],                                                                                                   +
                             "imagePullPolicy": "Always",                                                                         +
                             "terminationMessagePath": "/dev/termination-log",                                                    +
                             "terminationMessagePolicy": "File"                                                                   +
                         },                                                                                                       +
                         {                                                                                                        +
                             "env": [                                                                                             +
                                 {                                                                                                +
                                     "name": "CSI_ENDPOINT",                                                                      +
                                     "value": "unix:///csi/csi.sock"                                                              +
                                 },                                                                                               +
                                 {                                                                                                +
                                     "name": "KUBE_NODE_NAME",                                                                    +
                                     "valueFrom": {                                                                               +
                                         "fieldRef": {                                                                            +
                                             "fieldPath": "spec.nodeName",                                                        +
                                             "apiVersion": "v1"                                                                   +
                                         }                                                                                        +
                                     }                                                                                            +
                                 }                                                                                                +
                             ],                                                                                                   +
                             "args": [                                                                                            +
                                 "--v=5",                                                                                         +
                                 "--endpoint=$(CSI_ENDPOINT)",                                                                    +
                                 "--nodeid=$(KUBE_NODE_NAME)",                                                                    +
                                 "--drivername=csi-hostpath-v0-provisioning-5107"                                                 +
                             ],                                                                                                   +
                             "name": "hostpath",                                                                                  +
                             "image": "quay.io/k8scsi/hostpathplugin:v0.4.1",                                                     +
                             "resources": {                                                                                       +
                             },                                                                                                   +
                             "volumeMounts": [                                                                                    +
                                 {                                                                                                +
                                     "name": "socket-dir",                                                                        +
                                     "mountPath": "/csi"                                                                          +
                                 },                                                                                               +
                                 {                                                                                                +
                                     "name": "mountpoint-dir",                                                                    +
                                     "mountPath": "/var/lib/kubelet/pods",                                                        +
                                     "mountPropagation": "Bidirectional"                                                          +
                                 }                                                                                                +
                             ],                                                                                                   +
                             "imagePullPolicy": "Always",                                                                         +
                             "securityContext": {                                                                                 +
                                 "privileged": true                                                                               +
                             },                                                                                                   +
                             "terminationMessagePath": "/dev/termination-log",                                                    +
                             "terminationMessagePolicy": "File"                                                                   +
                         }                                                                                                        +
                     ],                                                                                                           +
                     "hostNetwork": true,                                                                                         +
                     "restartPolicy": "Always",                                                                                   +
                     "schedulerName": "default-scheduler",                                                                        +
                     "securityContext": {                                                                                         +
                     },                                                                                                           +
                     "terminationGracePeriodSeconds": 30                                                                          +
                 },                                                                                                               +
                 "metadata": {                                                                                                    +
                     "labels": {                                                                                                  +
                         "app": "csi-hostpathplugin"                                                                              +
                     },                                                                                                           +
                     "creationTimestamp": null                                                                                    +
                 }                                                                                                                +
             },                                                                                                                   +
             "updateStrategy": {                                                                                                  +
                 "type": "RollingUpdate",                                                                                         +
                 "rollingUpdate": {                                                                                               +
                     "maxUnavailable": 1                                                                                          +
                 }                                                                                                                +
             },                                                                                                                   +
             "revisionHistoryLimit": 10                                                                                           +
         },                                                                                                                       +
         "status": {                                                                                                              +
             "numberReady": 0,                                                                                                    +
             "numberUnavailable": 1,                                                                                              +
             "numberMisscheduled": 0,                                                                                             +
             "observedGeneration": 1,                                                                                             +
             "currentNumberScheduled": 1,                                                                                         +
             "desiredNumberScheduled": 1,                                                                                         +
             "updatedNumberScheduled": 1                                                                                          +
         },                                                                                                                       +
         "metadata": {                                                                                                            +
             "uid": "957e7745-4bf7-40ec-ae68-709ea534f9f0",                                                                       +
             "name": "csi-hostpathplugin",                                                                                        +
             "selfLink": "/apis/apps/v1/namespaces/provisioning-5107/daemonsets/csi-hostpathplugin",                              +
             "namespace": "provisioning-5107",                                                                                    +
             "generation": 1,                                                                                                     +
             "annotations": {                                                                                                     +
                 "deprecated.daemonset.template.generation": "1"                                                                  +
             },                                                                                                                   +
             "resourceVersion": "1278",                                                                                           +
             "creationTimestamp": "2019-09-16T01:50:54Z"                                                                          +
         },                                                                                                                       +
         "apiVersion": "apps/v1"                                                                                                  +
     }
     {                                                                                                                            +
         "kind": "DaemonSet",                                                                                                     +
         "spec": {                                                                                                                +
             "selector": {                                                                                                        +
                 "matchLabels": {                                                                                                 +
                     "app": "csi-hostpathplugin"                                                                                  +
                 }                                                                                                                +
             },                                                                                                                   +
             "template": {                                                                                                        +
                 "spec": {                                                                                                        +
                     "volumes": [                                                                                                 +
                         {                                                                                                        +
                             "name": "socket-dir",                                                                                +
                             "hostPath": {                                                                                        +
                                 "path": "/var/lib/kubelet/plugins/csi-hostpath-v0-provisioning-5107",                            +
                                 "type": "DirectoryOrCreate"                                                                      +
                             }                                                                                                    +
                         },                                                                                                       +
                         {                                                                                                        +
                             "name": "mountpoint-dir",                                                                            +
                             "hostPath": {                                                                                        +
                                 "path": "/var/lib/kubelet/pods",                                                                 +
                                 "type": "DirectoryOrCreate"                                                                      +
                             }                                                                                                    +
                         },                                                                                                       +
                         {                                                                                                        +
                             "name": "registration-dir",                                                                          +
                             "hostPath": {                                                                                        +
                                 "path": "/var/lib/kubelet/plugins",                                                              +
                                 "type": "Directory"                                                                              +
                             }                                                                                                    +
                         }                                                                                                        +
                     ],                                                                                                           +
                     "nodeName": "bootstrap-e2e-minion-group-8vfx",                                                               +
                     "dnsPolicy": "ClusterFirst",                                                                                 +
                     "containers": [                                                                                              +
                         {                                                                                                        +
                             "env": [                                                                                             +
                                 {                                                                                                +
                                     "name": "KUBE_NODE_NAME",                                                                    +
                                     "valueFrom": {                                                                               +
                                         "fieldRef": {                                                                            +
                                             "fieldPath": "spec.nodeName",                                                        +
                                             "apiVersion": "v1"                                                                   +
                                         }                                                                                        +
                                     }                                                                                            +
                                 }                                                                                                +
                             ],                                                                                                   +
                             "args": [                                                                                            +
                                 "--v=5",                                                                                         +
                                 "--csi-address=/csi/csi.sock",                                                                   +
                                 "--kubelet-registration-path=/var/lib/kubelet/plugins/csi-hostpath-v0-provisioning-5107/csi.sock"+
                             ],                                                                                                   +
                             "name": "driver-registrar",                                                                          +
                             "image": "quay.io/k8scsi/driver-registrar:v0.4.1",                                                   +
                             "resources": {                                                                                       +
                             },                                                                                                   +
                             "volumeMounts": [                                                                                    +
                                 {                                                                                                +
                                     "name": "socket-dir",                                                                        +
                                     "mountPath": "/csi"                                                                          +
                                 },                                                                                               +
                                 {                                                                                                +
                                     "name": "registration-dir",                                                                  +
                                     "mountPath": "/registration"                                                                 +
                                 }                                                                                                +
                             ],                                                                                                   +
                             "imagePullPolicy": "Always",                                                                         +
                             "terminationMessagePath": "/dev/termination-log",                                                    +
                             "terminationMessagePolicy": "File"                                                                   +
                         },                                                                                                       +
                         {                                                                                                        +
                             "env": [                                                                                             +
                                 {                                                                                                +
                                     "name": "CSI_ENDPOINT",                                                                      +
                                     "value": "unix:///csi/csi.sock"                                                              +
                                 },                                                                                               +
                                 {                                                                                                +
                                     "name": "KUBE_NODE_NAME",                                                                    +
                                     "valueFrom": {                                                                               +
                                         "fieldRef": {                                                                            +
                                             "fieldPath": "spec.nodeName",                                                        +
                                             "apiVersion": "v1"                                                                   +
                                         }                                                                                        +
                                     }                                                                                            +
                                 }                                                                                                +
                             ],                                                                                                   +
                             "args": [                                                                                            +
                                 "--v=5",                                                                                         +
                                 "--endpoint=$(CSI_ENDPOINT)",                                                                    +
                                 "--nodeid=$(KUBE_NODE_NAME)",                                                                    +
                                 "--drivername=csi-hostpath-v0-provisioning-5107"                                                 +
                             ],                                                                                                   +
                             "name": "hostpath",                                                                                  +
                             "image": "quay.io/k8scsi/hostpathplugin:v0.4.1",                                                     +
                             "resources": {                                                                                       +
                             },                                                                                                   +
                             "volumeMounts": [                                                                                    +
                                 {                                                                                                +
                                     "name": "socket-dir",                                                                        +
                                     "mountPath": "/csi"                                                                          +
                                 },                                                                                               +
                                 {                                                                                                +
                                     "name": "mountpoint-dir",                                                                    +
                                     "mountPath": "/var/lib/kubelet/pods",                                                        +
                                     "mountPropagation": "Bidirectional"                                                          +
                                 }                                                                                                +
                             ],                                                                                                   +
                             "imagePullPolicy": "Always",                                                                         +
                             "securityContext": {                                                                                 +
                                 "privileged": true                                                                               +
                             },                                                                                                   +
                             "terminationMessagePath": "/dev/termination-log",                                                    +
                             "terminationMessagePolicy": "File"                                                                   +
                         }                                                                                                        +
                     ],                                                                                                           +
                     "hostNetwork": true,                                                                                         +
                     "restartPolicy": "Always",                                                                                   +
                     "schedulerName": "default-scheduler",                                                                        +
                     "securityContext": {                                                                                         +
                     },                                                                                                           +
                     "terminationGracePeriodSeconds": 30                                                                          +
                 },                                                                                                               +
                 "metadata": {                                                                                                    +
                     "labels": {                                                                                                  +
                         "app": "csi-hostpathplugin"                                                                              +
                     },                                                                                                           +
                     "creationTimestamp": null                                                                                    +
                 }                                                                                                                +
             },                                                                                                                   +
             "updateStrategy": {                                                                                                  +
                 "type": "RollingUpdate",                                                                                         +
                 "rollingUpdate": {                                                                                               +
                     "maxUnavailable": 1                                                                                          +
                 }                                                                                                                +
             },                                                                                                                   +
             "revisionHistoryLimit": 10                                                                                           +
         },                                                                                                                       +
         "status": {                                                                                                              +
             "numberReady": 0,                                                                                                    +
             "numberUnavailable": 1,                                                                                              +
             "numberMisscheduled": 0,                                                                                             +
             "observedGeneration": 1,                                                                                             +
             "currentNumberScheduled": 1,                                                                                         +
             "desiredNumberScheduled": 1,                                                                                         +
             "updatedNumberScheduled": 1                                                                                          +
         },                                                                                                                       +
         "metadata": {                                                                                                            +
             "uid": "957e7745-4bf7-40ec-ae68-709ea534f9f0",                                                                       +
             "name": "csi-hostpathplugin",                                                                                        +
             "selfLink": "/apis/apps/v1/namespaces/provisioning-5107/daemonsets/csi-hostpathplugin",                              +
             "namespace": "provisioning-5107",                                                                                    +
             "generation": 1,                                                                                                     +
             "annotations": {                                                                                                     +
                 "deprecated.daemonset.template.generation": "1"                                                                  +
             },                                                                                                                   +
             "resourceVersion": "1278",                                                                                           +
             "creationTimestamp": "2019-09-16T01:50:54Z"                                                                          +
         },                                                                                                                       +
         "apiVersion": "apps/v1"                                                                                                  +
     }
    (2 rows)

    #+end_src
    This matches, and we can change around the event we are grabbing from to keep investgating...but first a side note. 
    
*** Side Note about our Audit Events
    One bit of weirdness when I did this was I was expecting a single result, cos there's just one id.  Instead, I got two.  I'd think an id was unique, unless there were duplicates events in our log.
    So I decided to look at the numbers for both of the audit events in my db.
    #+BEGIN_SRC sql-mode
      select 
        job,
        count(*) as all_events,
        count(distinct data) as distinct_events,
        count(distinct audit_id) as distinct_audit_ids
        FROM
            audit_event
        GROUP BY job;
    #+END_SRC

    #+RESULTS:
    #+begin_src sql-mode
             job         | all_events | distinct_events | distinct_audit_ids 
    ---------------------+------------+-----------------+--------------------
     1173412183980118017 |     400625 |          322676 |             313956
     1178464478988079104 |     404060 |          325712 |             316950
    (2 rows)

    #+end_src
    
    for both jobs, there are ≅80,000 more events than distinct events, and ≅10,000 more distinct events than distinct ids.  According to the [[https://stupefied-goodall-e282f7.netlify.com/contributors/design-proposals/api-machinery/auditing/][Auditing Design Proposal]], audit id's are not necessarily unique, but I am not sure why we are getting events with completely duplicate data.  This won't affect our look into whether something is tested or not, but it does affect the count of # of tests.  Perhaps we should sanitize the log further before adding it to the db, making sure to remove duplicate entries? 

** Rebuild our kind_field_path coverage for matrialized view
   Instead of doing the count right at the start, we'll do a materialized view of all records, and then aggregate from that.  This should improve performance.
   #+NAME: kind_field_path_coverage_material
   #+BEGIN_SRC sql-mode
     CREATE MATERIALIZED VIEW "public"."kind_field_path_coverage_material" AS
     SELECT
       f.bucket,
       f.job,
       f.kind,
       f.field_path,
       f.field_kind,
       ae.audit_id as audit_event_id
       FROM fieldwork f
           LEFT JOIN LATERAL (select * from audit_event WHERE param_schema = f.kind AND jsonb_path_exists(request_object, ('$.'||f.field_path)::jsonpath)) ae ON true
       GROUP BY f.kind, f.field_path, f.field_kind, f.bucket, f.job, ae.audit_id; 
   #+END_SRC

   #+RESULTS: kind_field_path_coverage_material
   #+begin_src sql-mode
   CREATE OR REPLACE VIEW kind_field_path_coverage AS
   SELECT * from kind_field_path_coverage_material;
   #+end_src

   #+RESULTS:
   #+begin_src sql-mode
   CREATE VIEW
   #+end_src
**    Sort kind_field_path coverage by distance
  #+BEGIN_SRC  sql-mode
    select distinct
      bucket,
      job,
      field_kind,
      field_path,
      kind,
      (array_length(string_to_array(field_path, '.'),1) - 1) as distance
      from kind_field_path_coverage
             ORDER BY distance DESC LIMIT 30;
  #+END_SRC

  #+RESULTS:
  #+begin_src sql-mode
            bucket           |         job         |                  field_kind                   |                                                                      field_path                                                                       |                     kind                     | distance 
  ---------------------------+---------------------+-----------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------+----------
   ci-kubernetes-e2e-gci-gce | 1173412183980118017 | io.k8s.apimachinery.pkg.api.resource.Quantity | items.spec.template.spec.volumes.projected.sources.downwardAPI.items.resourceFieldRef.divisor                                                         | io.k8s.api.apps.v1.DaemonSetList             |       10
   ci-kubernetes-e2e-gci-gce | 1173412183980118017 | io.k8s.apimachinery.pkg.api.resource.Quantity | items.spec.template.spec.volumes.projected.sources.downwardAPI.items.resourceFieldRef.divisor                                                         | io.k8s.api.apps.v1.DeploymentList            |       10
   ci-kubernetes-e2e-gci-gce | 1173412183980118017 | io.k8s.apimachinery.pkg.api.resource.Quantity | items.spec.template.spec.volumes.projected.sources.downwardAPI.items.resourceFieldRef.divisor                                                         | io.k8s.api.apps.v1.ReplicaSetList            |       10
   ci-kubernetes-e2e-gci-gce | 1173412183980118017 | io.k8s.apimachinery.pkg.api.resource.Quantity | items.spec.template.spec.volumes.projected.sources.downwardAPI.items.resourceFieldRef.divisor                                                         | io.k8s.api.apps.v1.StatefulSetList           |       10
   ci-kubernetes-e2e-gci-gce | 1173412183980118017 | io.k8s.apimachinery.pkg.api.resource.Quantity | items.spec.template.spec.volumes.projected.sources.downwardAPI.items.resourceFieldRef.divisor                                                         | io.k8s.api.batch.v1.JobList                  |       10
   ci-kubernetes-e2e-gci-gce | 1173412183980118017 | io.k8s.apimachinery.pkg.api.resource.Quantity | items.spec.template.spec.volumes.projected.sources.downwardAPI.items.resourceFieldRef.divisor                                                         | io.k8s.api.core.v1.ReplicationControllerList |       10
   ci-kubernetes-e2e-gci-gce | 1173412183980118017 | string                                        | items.spec.template.spec.affinity.podAffinity.preferredDuringSchedulingIgnoredDuringExecution.podAffinityTerm.labelSelector.matchExpressions.key      | io.k8s.api.apps.v1.DaemonSetList             |       10
   ci-kubernetes-e2e-gci-gce | 1173412183980118017 | string                                        | items.spec.template.spec.affinity.podAffinity.preferredDuringSchedulingIgnoredDuringExecution.podAffinityTerm.labelSelector.matchExpressions.key      | io.k8s.api.apps.v1.DeploymentList            |       10
   ci-kubernetes-e2e-gci-gce | 1173412183980118017 | string                                        | items.spec.template.spec.affinity.podAffinity.preferredDuringSchedulingIgnoredDuringExecution.podAffinityTerm.labelSelector.matchExpressions.key      | io.k8s.api.apps.v1.ReplicaSetList            |       10
   ci-kubernetes-e2e-gci-gce | 1173412183980118017 | string                                        | items.spec.template.spec.affinity.podAffinity.preferredDuringSchedulingIgnoredDuringExecution.podAffinityTerm.labelSelector.matchExpressions.key      | io.k8s.api.apps.v1.StatefulSetList           |       10
   ci-kubernetes-e2e-gci-gce | 1173412183980118017 | string                                        | items.spec.template.spec.affinity.podAffinity.preferredDuringSchedulingIgnoredDuringExecution.podAffinityTerm.labelSelector.matchExpressions.key      | io.k8s.api.batch.v1.JobList                  |       10
   ci-kubernetes-e2e-gci-gce | 1173412183980118017 | string                                        | items.spec.template.spec.affinity.podAffinity.preferredDuringSchedulingIgnoredDuringExecution.podAffinityTerm.labelSelector.matchExpressions.key      | io.k8s.api.core.v1.ReplicationControllerList |       10
   ci-kubernetes-e2e-gci-gce | 1173412183980118017 | string                                        | items.spec.template.spec.affinity.podAffinity.preferredDuringSchedulingIgnoredDuringExecution.podAffinityTerm.labelSelector.matchExpressions.operator | io.k8s.api.apps.v1.DaemonSetList             |       10
   ci-kubernetes-e2e-gci-gce | 1173412183980118017 | string                                        | items.spec.template.spec.affinity.podAffinity.preferredDuringSchedulingIgnoredDuringExecution.podAffinityTerm.labelSelector.matchExpressions.operator | io.k8s.api.apps.v1.DeploymentList            |       10
   ci-kubernetes-e2e-gci-gce | 1173412183980118017 | string                                        | items.spec.template.spec.affinity.podAffinity.preferredDuringSchedulingIgnoredDuringExecution.podAffinityTerm.labelSelector.matchExpressions.operator | io.k8s.api.apps.v1.ReplicaSetList            |       10
   ci-kubernetes-e2e-gci-gce | 1173412183980118017 | string                                        | items.spec.template.spec.affinity.podAffinity.preferredDuringSchedulingIgnoredDuringExecution.podAffinityTerm.labelSelector.matchExpressions.operator | io.k8s.api.apps.v1.StatefulSetList           |       10
   ci-kubernetes-e2e-gci-gce | 1173412183980118017 | string                                        | items.spec.template.spec.affinity.podAffinity.preferredDuringSchedulingIgnoredDuringExecution.podAffinityTerm.labelSelector.matchExpressions.operator | io.k8s.api.batch.v1.JobList                  |       10
   ci-kubernetes-e2e-gci-gce | 1173412183980118017 | string                                        | items.spec.template.spec.affinity.podAffinity.preferredDuringSchedulingIgnoredDuringExecution.podAffinityTerm.labelSelector.matchExpressions.operator | io.k8s.api.core.v1.ReplicationControllerList |       10
   ci-kubernetes-e2e-gci-gce | 1173412183980118017 | string                                        | items.spec.template.spec.affinity.podAffinity.preferredDuringSchedulingIgnoredDuringExecution.podAffinityTerm.labelSelector.matchExpressions.values   | io.k8s.api.apps.v1.DaemonSetList             |       10
   ci-kubernetes-e2e-gci-gce | 1173412183980118017 | string                                        | items.spec.template.spec.affinity.podAffinity.preferredDuringSchedulingIgnoredDuringExecution.podAffinityTerm.labelSelector.matchExpressions.values   | io.k8s.api.apps.v1.DeploymentList            |       10
   ci-kubernetes-e2e-gci-gce | 1173412183980118017 | string                                        | items.spec.template.spec.affinity.podAffinity.preferredDuringSchedulingIgnoredDuringExecution.podAffinityTerm.labelSelector.matchExpressions.values   | io.k8s.api.apps.v1.ReplicaSetList            |       10
   ci-kubernetes-e2e-gci-gce | 1173412183980118017 | string                                        | items.spec.template.spec.affinity.podAffinity.preferredDuringSchedulingIgnoredDuringExecution.podAffinityTerm.labelSelector.matchExpressions.values   | io.k8s.api.apps.v1.StatefulSetList           |       10
   ci-kubernetes-e2e-gci-gce | 1173412183980118017 | string                                        | items.spec.template.spec.affinity.podAffinity.preferredDuringSchedulingIgnoredDuringExecution.podAffinityTerm.labelSelector.matchExpressions.values   | io.k8s.api.batch.v1.JobList                  |       10
   ci-kubernetes-e2e-gci-gce | 1173412183980118017 | string                                        | items.spec.template.spec.affinity.podAffinity.preferredDuringSchedulingIgnoredDuringExecution.podAffinityTerm.labelSelector.matchExpressions.values   | io.k8s.api.core.v1.ReplicationControllerList |       10
   ci-kubernetes-e2e-gci-gce | 1173412183980118017 | string                                        | items.spec.template.spec.affinity.podAntiAffinity.preferredDuringSchedulingIgnoredDuringExecution.podAffinityTerm.labelSelector.matchExpressions.key  | io.k8s.api.apps.v1.DaemonSetList             |       10
   ci-kubernetes-e2e-gci-gce | 1173412183980118017 | string                                        | items.spec.template.spec.affinity.podAntiAffinity.preferredDuringSchedulingIgnoredDuringExecution.podAffinityTerm.labelSelector.matchExpressions.key  | io.k8s.api.apps.v1.DeploymentList            |       10
   ci-kubernetes-e2e-gci-gce | 1173412183980118017 | string                                        | items.spec.template.spec.affinity.podAntiAffinity.preferredDuringSchedulingIgnoredDuringExecution.podAffinityTerm.labelSelector.matchExpressions.key  | io.k8s.api.apps.v1.ReplicaSetList            |       10
   ci-kubernetes-e2e-gci-gce | 1173412183980118017 | string                                        | items.spec.template.spec.affinity.podAntiAffinity.preferredDuringSchedulingIgnoredDuringExecution.podAffinityTerm.labelSelector.matchExpressions.key  | io.k8s.api.apps.v1.StatefulSetList           |       10
   ci-kubernetes-e2e-gci-gce | 1173412183980118017 | string                                        | items.spec.template.spec.affinity.podAntiAffinity.preferredDuringSchedulingIgnoredDuringExecution.podAffinityTerm.labelSelector.matchExpressions.key  | io.k8s.api.batch.v1.JobList                  |       10
   ci-kubernetes-e2e-gci-gce | 1173412183980118017 | string                                        | items.spec.template.spec.affinity.podAntiAffinity.preferredDuringSchedulingIgnoredDuringExecution.podAffinityTerm.labelSelector.matchExpressions.key  | io.k8s.api.core.v1.ReplicationControllerList |       10
  (30 rows)

  #+end_src


* Conclusions || Next Steps
   This is definitely giving us results, but it feels a little strange how consistent the gaps in coverage are.  Essentially the top level kind will be hit, but all its descendants (the List and Spec kinds) will not be.  This is seen in the respective field_path coverage too.  Either this is the nature of coverage today, or I am misunderstanding how these subkinds are represented in the audit event, or the json traversal is not nuanced enough.  Next steps is to do some blunt sanity checking on the returned audit events, and check with chris on whether these values are making sense.  It's still a nice start.
** Next Steps:
   - ensure i am looking at the right thing.
   - if so, adjust the field_coverage to not be limited to one job and just podspec and containers.
     - include bucket and job as columns in the view.
* Footnotes
  #+NAME: Connect org to postgres
  #+BEGIN_SRC emacs-lisp :results silent
    (sql-connect "apisnoop" (concat "*SQL: postgres:data*"))
  #+END_SRC

- [ ] Test your connection works
  You can run this sql block, and it see a message in your minbuffer like:
  : You are connected to database "apisnoop" as user "apisnoop" on host "localhost" at port "10041".

  #+NAME: Test Connection
  #+BEGIN_SRC sql-mode :results silent
  \conninfo
  #+END_SRC

 
