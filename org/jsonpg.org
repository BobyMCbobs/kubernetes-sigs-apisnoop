#+TITLE: json => triggers => views in PostgreSQL
#+TODO: TODO | TADA


* operations
#+BEGIN_SRC  shell
cat ../swagger.json \
  | jq -c '.paths | to_entries | .[].value | to_entries | .[].value | {operationId: .operationId, parameters: .parameters, responses: .responses}'\
  | jq .
 # | head -10 | tail -1
#| {operationId:.operationId}' \
# .[].value | to_entries[][]' \
#  | head -200 | tail -1 | jq .
# | {operationId: .operationId}' \
# {"operationId": value.operationId, "parameter": value.parameters, "responses": value.responses}' #| head -200 | tail -1 | jq .
# |.[].value | to_entries[] | {"operationId": .operationId, "parameter": .parameters, "responses": .responses}'  | head -200 | tail -1 | jq .
#+END_SRC

#+RESULTS:
#+begin_EXAMPLE
{
  "operationId": "getCoreAPIVersions",
  "parameters": null,
  "responses": {
    "200": {
      "description": "OK",
      "schema": {
        "$ref": "#/definitions/io.k8s.apimachinery.pkg.apis.meta.v1.APIVersions"
      }
    },
    "401": {
      "description": "Unauthorized"
    }
  }
}
{
  "operationId": "getCoreV1APIResources",
  "parameters": null,
  "responses": {
    "200": {
      "description": "OK",
      "schema": {
        "$ref": "#/definitions/io.k8s.apimachinery.pkg.apis.meta.v1.APIResourceList"
      }
    },
    "401": {
      "description": "Unauthorized"
    }
  }
}
{
  "operationId": "listCoreV1ComponentStatus",
  "parameters": null,
  "responses": {
    "200": {
      "description": "OK",
      "schema": {
        "$ref": "#/definitions/io.k8s.api.core.v1.ComponentStatusList"
      }
    },
    "401": {
      "description": "Unauthorized"
    }
  }
}
#+end_EXAMPLE


* raw_json Table
#+NAME: raw_swaggers
#+BEGIN_SRC sql-mode 
CREATE TABLE raw_swaggers (
    id int GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ingested_at timestamp DEFAULT CURRENT_TIMESTAMP,
    -- version text NOT NULL,
    -- definition_id text NOT NULL,
    data jsonb NOT NULL
);
#+END_SRC

#+RESULTS: raw_swaggers
#+begin_src sql-mode
CREATE TABLE
#+end_src

#+NAME: raw_api_definitions
#+BEGIN_SRC sql-mode 
CREATE TABLE raw_api_definitions (
    id int GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ingested_at timestamp DEFAULT CURRENT_TIMESTAMP,
    -- version text NOT NULL,
    -- definition_id text NOT NULL,
    data jsonb NOT NULL
);
#+END_SRC

#+RESULTS: raw_api_definitions
#+begin_src sql-mode
CREATE TABLE
#+end_src

* raw_json Loader

https://www.postgresql.org/docs/current/sql-copy.html

#+BEGIN_SRC  shell
  cat ../swagger.json | jq -c '.definitions | to_entries | map(.value.definition = .key) | map(.value.version="local") | .[].value'  | wc -l
#+END_SRC

#+RESULTS:
#+begin_EXAMPLE
630
#+end_EXAMPLE

NEXT!
- pipe swagger's definitions into sql table
- ensure that when we go to 'hasura.sharing.io' you can see this table.
- construct some views, through sql and graphql.

#+BEGIN_SRC tmate
  cat ../swagger.json | jq -c . \
  | psql -c "COPY raw_swaggers (data) FROM STDIN (DELIMITER e'\x02', FORMAT 'csv', QUOTE e'\x01');"
#+END_SRC


#+BEGIN_SRC tmate
  cat ../swagger.json \
  | jq -c '.definitions | to_entries | map(.value.definition = .key) | map(.value.version="local") | .[].value' \
  | psql -c "COPY raw_api_definitions (data) FROM STDIN (DELIMITER e'\x02', FORMAT 'csv', QUOTE e'\x01');"
#+END_SRC

This is one line of json per line, which will be the 'jsonb' type for the data column when we import.

#+BEGIN_SRC shell
  cat swagger.json | jq '.definitions' | 
  | sort -R | grep -vi alpha\\\|beta | grep core | head -40 
cat data.json | psql -h localhost -p 5432 feeds -c \
  "COPY raw_api_definitions (definition_id,data) FROM STDIN with delimite;"
#  "COPY raw_api_definitions (data) FROM STDIN WITH version='master-123';"
#+END_SRC

* TADA Loading json quickly into pgqsl
  CLOSED: [2019-07-28 Sun 23:34]

* TODO Views

Well-designed relational databases store data in normalized form.
To access this data across scattered tables, you write queries to join underlying tables.

When you find yourself writing the same query over and over again, create a
view. Simply put, a view is nothing more than a query permanently stored in the
database.

Some purists have argued that one should always query a view, never tables. This
means you must create a view for every table that you intend to query directly.

The added layer of indirection eases management of permissions and facilitates abstraction of table data.
#+BEGIN_SRC sql-mode
DROP VIEW public.types;
#+END_SRC

#+RESULTS:
#+begin_src sql-mode
DROP VIEW
#+end_src

I wonder if it would be possible to add the types used by properties that are not $ref

#+BEGIN_SRC sql-mode
--  DROP VIEW public.types;
CREATE OR REPLACE VIEW "public"."types" AS 
 SELECT raw_api_definitions.id,
    (raw_api_definitions.data ->> 'definition'::text) AS name,
    (raw_api_definitions.data ->> 'description'::text) AS description,
    (((raw_api_definitions.data -> 'x-kubernetes-group-version-kind'::text) ->0) ->> 'group'::text) AS group,
    (((raw_api_definitions.data -> 'x-kubernetes-group-version-kind'::text) ->0) ->> 'version'::text) AS version,
    (((raw_api_definitions.data -> 'x-kubernetes-group-version-kind'::text) ->0) ->> 'kind'::text) AS kind,
    to_jsonb((raw_api_definitions.data -> 'properties')) AS properties,
    (raw_api_definitions.data ->> 'type'::text) AS type,
    (raw_api_definitions.data ->> 'required'::text) AS required,
    (raw_api_definitions.data ->> 'version'::text) AS source
   FROM raw_api_definitions;
#+END_SRC

#+RESULTS:
#+begin_src sql-mode
#+end_src

for all the types in the types view
list each property in this view

#+BEGIN_SRC sql-mode
DROP VIEW properties;
#+END_SRC

#+RESULTS:
#+begin_src sql-mode
DROP VIEW
#+end_src


#+BEGIN_SRC sql-mode
CREATE OR REPLACE FUNCTION jsonb_arr2text_arr(_js jsonb)
  RETURNS text[] LANGUAGE sql IMMUTABLE AS
'SELECT ARRAY(SELECT jsonb_array_elements_text(_js))';

CREATE OR REPLACE VIEW "public"."properties" AS 
 SELECT types.id AS type_id,
    types.name,
    types.group,
    types.version,
    types.kind,
    d.key AS property,
	(d.value ->> 'description'::text) AS description,
	(d.value ->> 'format'::text) AS format,
	(d.value ->> 'x-kubernetes-patch-merge-key'::text) AS merge_key,
	(d.value ->> 'x-kubernetes-patch-strategy'::text) AS patch_strategy,
	-- cast(jsonb_array_elements(types.required) as array) as required,
	-- ARRAY(SELECT json_arr2text_arr(types.required)) AS required,
	jsonb_arr2text_arr(types.required) AS required,
	-- SELECT jsonb_arr2text_arr(types.required) AS required,
	-- there is either a type OR $ref, not both
	-- so kind column here could be which ever is not null
	(d.value ->> 'type'::text) AS param_kind,
	replace((d.value ->> '$ref'::text),'#/definitions/','') AS kind_ref,
	-- if d.value.type is array, d.value.items will contain type OR $ref not both
	((d.value -> 'items'::text) ->> 'type'::text) AS array_kind,
	replace(((d.value -> 'items'::text) ->> '$ref'::text),'#/definitions/','') AS array_kind_ref
   FROM (types
     JOIN LATERAL jsonb_each(types.properties) d(key, value) ON (true))
  ORDER BY types.id;
#+END_SRC

#+RESULTS:
#+begin_src sql-mode
CREATE FUNCTION
CREATE VIEW
#+end_src


#+BEGIN_SRC sql-mode
\dv+ properties
#+END_SRC

#+RESULTS:
#+begin_src sql-mode
                       List of relations
 Schema |    Name    | Type |  Owner   |  Size   | Description 
--------+------------+------+----------+---------+-------------
 public | properties | view | postgres | 0 bytes | 
(1 row)

#+end_src

#+BEGIN_SRC sql-mode
select distinct name from properties where name like '%PodSpec';
#+END_SRC

#+RESULTS:
#+begin_src sql-mode
            name            
----------------------------
 io.k8s.api.core.v1.PodSpec
(1 row)

#+end_src
#+BEGIN_SRC sql-mode
select * from properties where merge_key is not null order by required DESC limit 100	;
#+END_SRC

#+RESULTS:
#+begin_src sql-mode
 type_id |                                   name                                   |            group             | version |              kind              |     property     |                                                                                                                                                                                                                                                                                                                                                                                                                                     description                                                                                                                                                                                                                                                                                                                                                                                                                                      | format |   merge_key   |  patch_strategy  |                                    required                                    | param_kind | kind_ref | array_kind |                               array_kind_ref                                
---------+--------------------------------------------------------------------------+------------------------------+---------+--------------------------------+------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------+---------------+------------------+--------------------------------------------------------------------------------+------------+----------+------------+-----------------------------------------------------------------------------
 1001332 | io.k8s.api.apps.v1beta1.StatefulSetStatus                                |                              |         |                                | conditions       | Represents the latest available observations of a statefulset's current state.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |        | type          | merge            | {replicas}                                                                     | array      |          |            | io.k8s.api.apps.v1beta1.StatefulSetCondition
 1001303 | io.k8s.api.apps.v1.ReplicaSetStatus                                      |                              |         |                                | conditions       | Represents the latest available observations of a replica set's current state.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |        | type          | merge            | {replicas}                                                                     | array      |          |            | io.k8s.api.apps.v1.ReplicaSetCondition
 1001352 | io.k8s.api.apps.v1beta2.ReplicaSetStatus                                 |                              |         |                                | conditions       | Represents the latest available observations of a replica set's current state.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |        | type          | merge            | {replicas}                                                                     | array      |          |            | io.k8s.api.apps.v1beta2.ReplicaSetCondition
 1001363 | io.k8s.api.apps.v1beta2.StatefulSetStatus                                |                              |         |                                | conditions       | Represents the latest available observations of a statefulset's current state.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |        | type          | merge            | {replicas}                                                                     | array      |          |            | io.k8s.api.apps.v1beta2.StatefulSetCondition
 1001615 | io.k8s.api.core.v1.ReplicationControllerStatus                           |                              |         |                                | conditions       | Represents the latest available observations of a replication controller's current state.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |        | type          | merge            | {replicas}                                                                     | array      |          |            | io.k8s.api.core.v1.ReplicationControllerCondition
 1001311 | io.k8s.api.apps.v1.StatefulSetStatus                                     |                              |         |                                | conditions       | Represents the latest available observations of a statefulset's current state.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |        | type          | merge            | {replicas}                                                                     | array      |          |            | io.k8s.api.apps.v1.StatefulSetCondition
 1001707 | io.k8s.api.extensions.v1beta1.ReplicaSetStatus                           |                              |         |                                | conditions       | Represents the latest available observations of a replica set's current state.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |        | type          | merge            | {replicas}                                                                     | array      |          |            | io.k8s.api.extensions.v1beta1.ReplicaSetCondition
 1001505 | io.k8s.api.core.v1.Container                                             |                              |         |                                | env              | List of environment variables to set in the container. Cannot be updated.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |        | name          | merge            | {name}                                                                         | array      |          |            | io.k8s.api.core.v1.EnvVar
 1001505 | io.k8s.api.core.v1.Container                                             |                              |         |                                | volumeDevices    | volumeDevices is the list of block devices to be used by the container. This is a beta feature.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |        | devicePath    | merge            | {name}                                                                         | array      |          |            | io.k8s.api.core.v1.VolumeDevice
 1001505 | io.k8s.api.core.v1.Container                                             |                              |         |                                | ports            | List of ports to expose from the container. Exposing a port here gives the system additional information about the network connections a container uses, but is primarily informational. Not specifying a port here DOES NOT prevent that port from being exposed. Any port which is listening on the default "0.0.0.0" address inside a container will be accessible from the network. Cannot be updated.                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |        | containerPort | merge            | {name}                                                                         | array      |          |            | io.k8s.api.core.v1.ContainerPort
 1001505 | io.k8s.api.core.v1.Container                                             |                              |         |                                | volumeMounts     | Pod volumes to mount into the container's filesystem. Cannot be updated.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |        | mountPath     | merge            | {name}                                                                         | array      |          |            | io.k8s.api.core.v1.VolumeMount
 1001868 | io.k8s.apimachinery.pkg.apis.meta.v1.LabelSelectorRequirement            |                              |         |                                | key              | key is the label key that the selector applies to.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |        | key           | merge            | {key,operator}                                                                 | string     |          |            | 
 1001827 | io.k8s.api.storage.v1beta1.CSINodeSpec                                   |                              |         |                                | drivers          | drivers is a list of information of all CSI Drivers existing on a node. If all drivers in the list are uninstalled, this can become empty.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |        | name          | merge            | {drivers}                                                                      | array      |          |            | io.k8s.api.storage.v1beta1.CSINodeDriver
 1001340 | io.k8s.api.apps.v1beta2.DaemonSetStatus                                  |                              |         |                                | conditions       | Represents the latest available observations of a DaemonSet's current state.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |        | type          | merge            | {currentNumberScheduled,numberMisscheduled,desiredNumberScheduled,numberReady} | array      |          |            | io.k8s.api.apps.v1beta2.DaemonSetCondition
 1001291 | io.k8s.api.apps.v1.DaemonSetStatus                                       |                              |         |                                | conditions       | Represents the latest available observations of a DaemonSet's current state.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |        | type          | merge            | {currentNumberScheduled,numberMisscheduled,desiredNumberScheduled,numberReady} | array      |          |            | io.k8s.api.apps.v1.DaemonSetCondition
 1001671 | io.k8s.api.extensions.v1beta1.DaemonSetStatus                            |                              |         |                                | conditions       | Represents the latest available observations of a DaemonSet's current state.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |        | type          | merge            | {currentNumberScheduled,numberMisscheduled,desiredNumberScheduled,numberReady} | array      |          |            | io.k8s.api.extensions.v1beta1.DaemonSetCondition
 1001599 | io.k8s.api.core.v1.PodSpec                                               |                              |         |                                | volumes          | List of volumes that can be mounted by containers belonging to the pod. More info: https://kubernetes.io/docs/concepts/storage/volumes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |        | name          | merge,retainKeys | {containers}                                                                   | array      |          |            | io.k8s.api.core.v1.Volume
 1001599 | io.k8s.api.core.v1.PodSpec                                               |                              |         |                                | containers       | List of containers belonging to the pod. Containers cannot currently be added or removed. There must be at least one container in a Pod. Cannot be updated.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |        | name          | merge            | {containers}                                                                   | array      |          |            | io.k8s.api.core.v1.Container
 1001599 | io.k8s.api.core.v1.PodSpec                                               |                              |         |                                | hostAliases      | HostAliases is an optional list of hosts and IPs that will be injected into the pod's hosts file if specified. This is only valid for non-hostNetwork pods.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |        | ip            | merge            | {containers}                                                                   | array      |          |            | io.k8s.api.core.v1.HostAlias
 1001599 | io.k8s.api.core.v1.PodSpec                                               |                              |         |                                | initContainers   | List of initialization containers belonging to the pod. Init containers are executed in order prior to containers being started. If any init container fails, the pod is considered to have failed and is handled according to its restartPolicy. The name for an init container or normal container must be unique among all containers. Init containers may not have Lifecycle actions, Readiness probes, or Liveness probes. The resourceRequirements of an init container are taken into account during scheduling by finding the highest request/limit for each resource type, and then using the max of of that value or the sum of the normal containers. Limits are applied to init containers in a similar fashion. Init containers cannot currently be added or removed. Cannot be updated. More info: https://kubernetes.io/docs/concepts/workloads/pods/init-containers/ |        | name          | merge            | {containers}                                                                   | array      |          |            | io.k8s.api.core.v1.Container
 1001599 | io.k8s.api.core.v1.PodSpec                                               |                              |         |                                | imagePullSecrets | ImagePullSecrets is an optional list of references to secrets in the same namespace to use for pulling any of the images used by this PodSpec. If specified, these secrets will be passed to individual puller implementations for them to use. For example, in the case of docker, only DockerConfig type secrets are honored. More info: https://kubernetes.io/docs/concepts/containers/images#specifying-imagepullsecrets-on-a-pod                                                                                                                                                                                                                                                                                                                                                                                                                                                |        | name          | merge            | {containers}                                                                   | array      |          |            | io.k8s.api.core.v1.LocalObjectReference
 1001573 | io.k8s.api.core.v1.NodeStatus                                            |                              |         |                                | addresses        | List of addresses reachable to the node. Queried from cloud provider, if available. More info: https://kubernetes.io/docs/concepts/nodes/node/#addresses Note: This field is declared as mergeable, but the merge key is not sufficiently unique, which can cause data corruption when it is merged. Callers should instead use a full-replacement patch. See http://pr.k8s.io/79391 for an example.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |        | type          | merge            | {}                                                                             | array      |          |            | io.k8s.api.core.v1.NodeAddress
 1001273 | io.k8s.api.admissionregistration.v1.ValidatingWebhookConfiguration       | admissionregistration.k8s.io | v1      | ValidatingWebhookConfiguration | webhooks         | Webhooks is a list of webhooks and the affected resources and operations.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |        | name          | merge            | {}                                                                             | array      |          |            | io.k8s.api.admissionregistration.v1.ValidatingWebhook
 1001277 | io.k8s.api.admissionregistration.v1beta1.MutatingWebhookConfiguration    | admissionregistration.k8s.io | v1beta1 | MutatingWebhookConfiguration   | webhooks         | Webhooks is a list of webhooks and the affected resources and operations.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |        | name          | merge            | {}                                                                             | array      |          |            | io.k8s.api.admissionregistration.v1beta1.MutatingWebhook
 1001282 | io.k8s.api.admissionregistration.v1beta1.ValidatingWebhookConfiguration  | admissionregistration.k8s.io | v1beta1 | ValidatingWebhookConfiguration | webhooks         | Webhooks is a list of webhooks and the affected resources and operations.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |        | name          | merge            | {}                                                                             | array      |          |            | io.k8s.api.admissionregistration.v1beta1.ValidatingWebhook
 1001297 | io.k8s.api.apps.v1.DeploymentStatus                                      |                              |         |                                | conditions       | Represents the latest available observations of a deployment's current state.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |        | type          | merge            | {}                                                                             | array      |          |            | io.k8s.api.apps.v1.DeploymentCondition
 1001320 | io.k8s.api.apps.v1beta1.DeploymentStatus                                 |                              |         |                                | conditions       | Represents the latest available observations of a deployment's current state.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |        | type          | merge            | {}                                                                             | array      |          |            | io.k8s.api.apps.v1beta1.DeploymentCondition
 1001346 | io.k8s.api.apps.v1beta2.DeploymentStatus                                 |                              |         |                                | conditions       | Represents the latest available observations of a deployment's current state.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |        | type          | merge            | {}                                                                             | array      |          |            | io.k8s.api.apps.v1beta2.DeploymentCondition
 1001458 | io.k8s.api.batch.v1.JobStatus                                            |                              |         |                                | conditions       | The latest available observations of an object's current state. More info: https://kubernetes.io/docs/concepts/workloads/controllers/jobs-run-to-completion/                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |        | type          | merge            | {}                                                                             | array      |          |            | io.k8s.api.batch.v1.JobCondition
 1001496 | io.k8s.api.core.v1.ComponentStatus                                       |                              | v1      | ComponentStatus                | conditions       | List of component conditions observed                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |        | type          | merge            | {}                                                                             | array      |          |            | io.k8s.api.core.v1.ComponentCondition
 1001268 | io.k8s.api.admissionregistration.v1.MutatingWebhookConfiguration         | admissionregistration.k8s.io | v1      | MutatingWebhookConfiguration   | webhooks         | Webhooks is a list of webhooks and the affected resources and operations.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |        | name          | merge            | {}                                                                             | array      |          |            | io.k8s.api.admissionregistration.v1.MutatingWebhook
 1001573 | io.k8s.api.core.v1.NodeStatus                                            |                              |         |                                | conditions       | Conditions is an array of current observed node conditions. More info: https://kubernetes.io/docs/concepts/nodes/node/#condition                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |        | type          | merge            | {}                                                                             | array      |          |            | io.k8s.api.core.v1.NodeCondition
 1001582 | io.k8s.api.core.v1.PersistentVolumeClaimStatus                           |                              |         |                                | conditions       | Current Condition of persistent volume claim. If underlying persistent volume is being resized then the Condition will be set to 'ResizeStarted'.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |        | type          | merge            | {}                                                                             | array      |          |            | io.k8s.api.core.v1.PersistentVolumeClaimCondition
 1001600 | io.k8s.api.core.v1.PodStatus                                             |                              |         |                                | podIPs           | podIPs holds the IP addresses allocated to the pod. If this field is specified, the 0th entry must match the podIP field. Pods may be allocated at most 1 value for each of IPv4 and IPv6. This list is empty if no IPs have been allocated yet.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |        | ip            | merge            | {}                                                                             | array      |          |            | io.k8s.api.core.v1.PodIP
 1001600 | io.k8s.api.core.v1.PodStatus                                             |                              |         |                                | conditions       | Current service state of pod. More info: https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle#pod-conditions                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |        | type          | merge            | {}                                                                             | array      |          |            | io.k8s.api.core.v1.PodCondition
 1001636 | io.k8s.api.core.v1.ServiceAccount                                        |                              | v1      | ServiceAccount                 | secrets          | Secrets is the list of secrets allowed to be used by pods running using this ServiceAccount. More info: https://kubernetes.io/docs/concepts/configuration/secret                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |        | name          | merge            | {}                                                                             | array      |          |            | io.k8s.api.core.v1.ObjectReference
 1001641 | io.k8s.api.core.v1.ServiceSpec                                           |                              |         |                                | ports            | The list of ports that are exposed by this service. More info: https://kubernetes.io/docs/concepts/services-networking/service/#virtual-ips-and-service-proxies                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |        | port          | merge            | {}                                                                             | array      |          |            | io.k8s.api.core.v1.ServicePort
 1001678 | io.k8s.api.extensions.v1beta1.DeploymentStatus                           |                              |         |                                | conditions       | Represents the latest available observations of a deployment's current state.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |        | type          | merge            | {}                                                                             | array      |          |            | io.k8s.api.extensions.v1beta1.DeploymentCondition
 1001872 | io.k8s.apimachinery.pkg.apis.meta.v1.ObjectMeta                          |                              |         |                                | ownerReferences  | List of objects depended by this object. If ALL objects in the list have been deleted, this object will be garbage collected. If this object is managed by a controller, then an entry in this list will point to this controller, with the controller field set to true. There cannot be more than one managing controller.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |        | uid           | merge            | {}                                                                             | array      |          |            | io.k8s.apimachinery.pkg.apis.meta.v1.OwnerReference
 1001889 | io.k8s.kube-aggregator.pkg.apis.apiregistration.v1.APIServiceStatus      |                              |         |                                | conditions       | Current service state of apiService.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |        | type          | merge            | {}                                                                             | array      |          |            | io.k8s.kube-aggregator.pkg.apis.apiregistration.v1.APIServiceCondition
 1001895 | io.k8s.kube-aggregator.pkg.apis.apiregistration.v1beta1.APIServiceStatus |                              |         |                                | conditions       | Current service state of apiService.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |        | type          | merge            | {}                                                                             | array      |          |            | io.k8s.kube-aggregator.pkg.apis.apiregistration.v1beta1.APIServiceCondition
(41 rows)

#+end_src


#+BEGIN_SRC sql-mode
select "group"
  , version
  , kind
  , name
  , property
  , required
--, format
, kind_ref
-- , array_kind_ref
-- ,patch_strategy, merge_key
 from properties
where 
(
    kind_ref like 'io.k8s.api.core.v1.Pod%'
--    kind_ref like 'io.k8s.api.core.v1.Pod%Spec%'
--  or kind_ref like 'io.k8s.api.apps.v1.%Spec'
) and
name not like '%beta%'
and name not like '%alpha%'
order by kind ;
-- and merge_key is not null
-- order by merge_key
-- limit 20;
#+END_SRC

#+RESULTS:
#+begin_src sql-mode
 group | version |    kind     |                     name                     |    property     |            required             |               kind_ref                
-------+---------+-------------+----------------------------------------------+-----------------+---------------------------------+---------------------------------------
       | v1      | Pod         | io.k8s.api.core.v1.Pod                       | spec            | {}                              | io.k8s.api.core.v1.PodSpec
       | v1      | Pod         | io.k8s.api.core.v1.Pod                       | status          | {}                              | io.k8s.api.core.v1.PodStatus
       | v1      | PodTemplate | io.k8s.api.core.v1.PodTemplate               | template        | {}                              | io.k8s.api.core.v1.PodTemplateSpec
       |         |             | io.k8s.api.apps.v1.StatefulSetSpec           | template        | {selector,template,serviceName} | io.k8s.api.core.v1.PodTemplateSpec
       |         |             | io.k8s.api.batch.v1.JobSpec                  | template        | {template}                      | io.k8s.api.core.v1.PodTemplateSpec
       |         |             | io.k8s.api.core.v1.Affinity                  | podAffinity     | {}                              | io.k8s.api.core.v1.PodAffinity
       |         |             | io.k8s.api.core.v1.Affinity                  | podAntiAffinity | {}                              | io.k8s.api.core.v1.PodAntiAffinity
       |         |             | io.k8s.api.core.v1.PodSpec                   | dnsConfig       | {containers}                    | io.k8s.api.core.v1.PodDNSConfig
       |         |             | io.k8s.api.core.v1.PodSpec                   | securityContext | {containers}                    | io.k8s.api.core.v1.PodSecurityContext
       |         |             | io.k8s.api.core.v1.PodTemplateSpec           | spec            | {}                              | io.k8s.api.core.v1.PodSpec
       |         |             | io.k8s.api.core.v1.ReplicationControllerSpec | template        | {}                              | io.k8s.api.core.v1.PodTemplateSpec
       |         |             | io.k8s.api.apps.v1.DaemonSetSpec             | template        | {selector,template}             | io.k8s.api.core.v1.PodTemplateSpec
       |         |             | io.k8s.api.core.v1.WeightedPodAffinityTerm   | podAffinityTerm | {weight,podAffinityTerm}        | io.k8s.api.core.v1.PodAffinityTerm
       |         |             | io.k8s.api.apps.v1.DeploymentSpec            | template        | {selector,template}             | io.k8s.api.core.v1.PodTemplateSpec
       |         |             | io.k8s.api.apps.v1.ReplicaSetSpec            | template        | {selector}                      | io.k8s.api.core.v1.PodTemplateSpec
(15 rows)

#+end_src


#+BEGIN_SRC sql-mode
CREATE OR REPLACE VIEW "public"."properties" AS 
 SELECT prop.def_id,
    (prop ->> 'name'::text) AS name,
    (prop ->> 'description'::text) AS description,
    (prop ->> 'type'::text) AS type,
    (prop ->> '$ref'::text) AS type_ref,
    (prop ->> 'items'::text) AS type_ref,
    (raw_api_definitions.data ->> 'description'::text) AS description,
    (prop -> 'descrt
    types.properties. ((( ))) AS name,
    (raw_api_definitions.data ->> 'version'::text) AS source
   FROM types where prop is ;
#+END_SRC


#+RESULTS:
#+begin_src sql-mode
CREATE VIEW
#+end_src

#+BEGIN_SRC sql-mode
 EXPLAIN SELECT raw_api_definitions.id,
    (raw_api_definitions.data ->> 'definition'::text) AS name,
    (raw_api_definitions.data ->> 'description'::text) AS description,
    (((raw_api_definitions.data -> 'x-kubernetes-group-version-kind'::text) ->0) ->> 'group'::text) AS group,
    (((raw_api_definitions.data -> 'x-kubernetes-group-version-kind'::text) ->0) ->> 'version'::text) AS version,
    (((raw_api_definitions.data -> 'x-kubernetes-group-version-kind'::text) ->0) ->> 'kind'::text) AS kind,
    (raw_api_definitions.data ->> 'type'::text) AS type,
    (raw_api_definitions.data ->> 'required'::text) AS required,
    (raw_api_definitions.data ->> 'version'::text) AS source
   FROM raw_api_definitions;
#+END_SRC

#+RESULTS:
#+begin_src sql-mode
                                QUERY PLAN                                 
---------------------------------------------------------------------------
 Seq Scan on raw_api_definitions  (cost=0.00..39472.46 rows=588 width=260)
(1 row)

#+end_src


#+BEGIN_SRC sql-mode
--  DROP VIEW public.types;
CREATE OR REPLACE VIEW "public"."types" AS 
 SELECT raw_api_definitions.id,
    (raw_api_definitions.data ->> 'definition'::text) AS name,
    (raw_api_definitions.data ->> 'description'::text) AS description,
    (((raw_api_definitions.data -> 'x-kubernetes-group-version-kind'::text) ->0) ->> 'group'::text) AS group,
    (((raw_api_definitions.data -> 'x-kubernetes-group-version-kind'::text) ->0) ->> 'version'::text) AS version,
    (((raw_api_definitions.data -> 'x-kubernetes-group-version-kind'::text) ->0) ->> 'kind'::text) AS kind,
    (raw_api_definitions.data ->> 'type'::text) AS type,
    (raw_api_definitions.data ->> 'required'::text) AS required,
    (raw_api_definitions.data ->> 'version'::text) AS source
   FROM raw_api_definitions;
#+END_SRC


#+BEGIN_SRC sql-mode
SELECT raw_api_definitions.id,
    (raw_api_definitions.data ->> 'definition'::text) AS name,
    (raw_api_definitions.data ->> 'description'::text) AS description,
    (((raw_api_definitions.data -> 'x-kubernetes-group-version-kind'::text) ->0) ->> 'group'::text) AS group,
    (((raw_api_definitions.data -> 'x-kubernetes-group-version-kind'::text) ->0) ->> 'version'::text) AS version,
    (((raw_api_definitions.data -> 'x-kubernetes-group-version-kind'::text) ->0) ->> 'kind'::text) AS kind,
    (raw_api_definitions.data ->> 'type'::text) AS type,
    (raw_api_definitions.data ->> 'required'::text) AS required,
    (raw_api_definitions.data ->> 'version'::text) AS source
   FROM raw_api_definitions
   LIMIT 10;

#+END_SRC

The types view contains a 'properties' column, that is a json Object with dynamic keys (each key being a property name).

If we wanted a view of just these records, then we can use the postgres function json_each, which'll create a record for each key value pair ina  json.

#+BEGIN_SRC sql-mode
-- DROP view public.properties;
CREATE OR REPLACE VIEW "public"."properties" AS 
 SELECT types.id AS type_id,
    d.key AS property,
    d.value AS value,
    ((types.property -> d.key::text) ->> 'description'::text) AS description
    -- (d.value ->> 'description'::text) AS description
--    d.value ->> 'description' AS description
   FROM (types
     JOIN LATERAL jsonb_each(types.properties) d(key, value) ON (true))
  ORDER BY types.id;
#+END_SRC

#+RESULTS:
#+begin_src sql-mode
#+end_src

#+BEGIN_SRC sql-mode
  SELECT
    coalesce(json_agg("root"), '[]') AS "root"
    limit 5
  FROM
    (
      SELECT
        row_to_json(
          (
            SELECT
              "_4_e"
            FROM
              (
                SELECT
                  "_0_root.base"."property" AS "property",
                  "_0_root.base"."value" AS "value",
                  "_3_root.or.parent_type"."parent_type" AS "parent_type"
              ) AS "_4_e"
          )
        ) AS "root"
      FROM
        (
          SELECT
            ,*
          FROM
            "public"."properties"
          WHERE
            (
              (
                ("public"."properties"."value") ? (('type') :: text)
              )
              AND (
                ("public"."properties"."value") @ > (('{"type":"string"}') :: jsonb)
              )
            )
        ) AS "_0_root.base"
        LEFT OUTER JOIN LATERAL (
          SELECT
            row_to_json(
              (
                SELECT
                  "_2_e"
                FROM
                  (
                    SELECT
                      "_1_root.or.parent_type.base"."name" AS "name"
                  ) AS "_2_e"
              )
            ) AS "parent_type"
          FROM
            (
              SELECT
                ,*
              FROM
                "public"."types"
              WHERE
                (("_0_root.base"."type_id") = ("id"))
            ) AS "_1_root.or.parent_type.base"
        ) AS "_3_root.or.parent_type" ON ('true')
    ) AS "_5_root";
#+END_SRC

#+RESULTS:
#+begin_src sql-mode
ERROR:  syntax error at or near "FROM"
LINE 4: FROM
        ^
#+end_src

* TODO Materialized views

Version 9.3 also introduced materialized views.

When you mark a view as materialized, it will requery the data only when you
issue the REFRESH command.

The upside is that you’re not wasting resources running complex queries
repeatedly; the downside is that you might not have the most up-to-date data
when you use the view.

The most convincing cases for using materialized views are when the underlying
query takes a long time and when having timely data is not critical.

You often encounter these scenarios when building online analytical processing
(OLAP) applications. Unlike nonmaterialized views, you can add indexes to
materialized views to speed up the read.

* TODO Creating index on Regular Expressions

You can find a wonderful example of GIN in Waiting for Faster LIKE/ILIKE.
As of version 9.3, you can index regular expressions that leverage the GIN-based pg_trgm extension.

https://www.postgresql.org/docs/current/pgtrgm.html

#+BEGIN_EXAMPLE
Beginning in PostgreSQL 9.3, these index types also support
index searches for regular-expression matches (~ and ~* operators),
for example

SELECT * FROM test_trgm WHERE t ~ '(foo|bar)';

The index search works by extracting trigrams from the regular expression and
then looking these up in the index.

The more trigrams that can be extracted from the regular expression, the more
effective the index search is.

Unlike B-tree based searches, the search string need not be left-anchored.
#+END_EXAMPLE

** Need to create a view

that includes ev.op_id with join on ev.verb ~ op.method and ev.request_uri ~ op.regex

#+BEGIN_SRC sql-mode
select ev.verb, op.method, op.path, ev.request_uri 
from api_operations op, audit_events ev
where ev.request_uri='/api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0'
and ev.request_uri ~ op.regexp;
#+END_SRC

#+RESULTS:
#+begin_src sql-mode
  verb  | method |                    path                    |                            request_uri                            
--------+--------+--------------------------------------------+-------------------------------------------------------------------
 get    | get    | /api/v1/namespaces/{namespace}/pods/{name} | /api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0
 get    | get    | /api/v1/namespaces/{namespace}/pods/{name} | /api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0
 get    | get    | /api/v1/namespaces/{namespace}/pods/{name} | /api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0
 get    | get    | /api/v1/namespaces/{namespace}/pods/{name} | /api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0
 get    | get    | /api/v1/namespaces/{namespace}/pods/{name} | /api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0
 get    | get    | /api/v1/namespaces/{namespace}/pods/{name} | /api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0
 get    | get    | /api/v1/namespaces/{namespace}/pods/{name} | /api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0
 get    | get    | /api/v1/namespaces/{namespace}/pods/{name} | /api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0
 delete | get    | /api/v1/namespaces/{namespace}/pods/{name} | /api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0
 delete | get    | /api/v1/namespaces/{namespace}/pods/{name} | /api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0
 get    | put    | /api/v1/namespaces/{namespace}/pods/{name} | /api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0
 get    | put    | /api/v1/namespaces/{namespace}/pods/{name} | /api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0
 get    | put    | /api/v1/namespaces/{namespace}/pods/{name} | /api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0
 get    | put    | /api/v1/namespaces/{namespace}/pods/{name} | /api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0
 get    | put    | /api/v1/namespaces/{namespace}/pods/{name} | /api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0
 get    | put    | /api/v1/namespaces/{namespace}/pods/{name} | /api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0
 get    | put    | /api/v1/namespaces/{namespace}/pods/{name} | /api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0
 get    | put    | /api/v1/namespaces/{namespace}/pods/{name} | /api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0
 delete | put    | /api/v1/namespaces/{namespace}/pods/{name} | /api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0
 delete | put    | /api/v1/namespaces/{namespace}/pods/{name} | /api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0
 get    | delete | /api/v1/namespaces/{namespace}/pods/{name} | /api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0
 get    | delete | /api/v1/namespaces/{namespace}/pods/{name} | /api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0
 get    | delete | /api/v1/namespaces/{namespace}/pods/{name} | /api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0
 get    | delete | /api/v1/namespaces/{namespace}/pods/{name} | /api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0
 get    | delete | /api/v1/namespaces/{namespace}/pods/{name} | /api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0
 get    | delete | /api/v1/namespaces/{namespace}/pods/{name} | /api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0
 get    | delete | /api/v1/namespaces/{namespace}/pods/{name} | /api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0
 get    | delete | /api/v1/namespaces/{namespace}/pods/{name} | /api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0
 delete | delete | /api/v1/namespaces/{namespace}/pods/{name} | /api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0
 delete | delete | /api/v1/namespaces/{namespace}/pods/{name} | /api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0
 get    | patch  | /api/v1/namespaces/{namespace}/pods/{name} | /api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0
 get    | patch  | /api/v1/namespaces/{namespace}/pods/{name} | /api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0
 get    | patch  | /api/v1/namespaces/{namespace}/pods/{name} | /api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0
 get    | patch  | /api/v1/namespaces/{namespace}/pods/{name} | /api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0
 get    | patch  | /api/v1/namespaces/{namespace}/pods/{name} | /api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0
 get    | patch  | /api/v1/namespaces/{namespace}/pods/{name} | /api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0
 get    | patch  | /api/v1/namespaces/{namespace}/pods/{name} | /api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0
 get    | patch  | /api/v1/namespaces/{namespace}/pods/{name} | /api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0
 delete | patch  | /api/v1/namespaces/{namespace}/pods/{name} | /api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0
 delete | patch  | /api/v1/namespaces/{namespace}/pods/{name} | /api/v1/namespaces/provisioning-4337/pods/csi-hostpath-attacher-0
(40 rows)

#+end_src


** pg_tgrm index creation

#+BEGIN_SRC sql-mode
CREATE EXTENSION pg_trgm;
#+END_SRC

#+RESULTS:
#+begin_src sql-mode
CREATE EXTENSION
#+end_src

#+BEGIN_SRC sql-mode
create index api_operation_regex ON api_operations USING GIST (regexp gist_trgm_ops);
#+END_SRC

#+BEGIN_SRC sql-mode
create index api_operation_regex_gin ON api_operations USING GIN (regexp gin_trgm_ops);
#+END_SRC

#+RESULTS:
#+begin_src sql-mode
CREATE INDEX
#+end_src

#+BEGIN_SRC sql-mode
reindex table api_operations;
#+END_SRC

#+RESULTS:
#+begin_src sql-mode
REINDEX
#+end_src



* More JSON functions:
** json_build_array
** json_build_object
** json_object
** json_to_record
** json_to_recordset

